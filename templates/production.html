{% extends "base.html" %}
{% block title %}{{ _('Production Logs') }}{% endblock %}
{% block content %}
<h1>{{ _('Production Logs') }}</h1>

<!-- Form to Log New Production -->
<form method="POST" class="p-4 bg-white border rounded shadow-sm">
    <div class="form-group">
        <label for="timestamp">{{ _('Timestamp') }}</label>
        <input type="datetime-local" id="timestamp" name="timestamp" class="form-control" value="{{ current_time }}" required>
    </div>
    <div class="form-group mb-3">
        <label for="product_id" class="form-label">{{ _('Select Product') }}</label>
        <select id="product_id" name="product_id" class="form-select select2" required>
            <option value="" disabled selected>בחר מוצר...</option>
            {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group mb-3">
        <label for="quantity_produced">{{ _('Quantity Produced') }} (מספר באצ'ים)</label>
        <input type="number" id="quantity_produced" name="quantity_produced" class="form-control" step="1" required oninput="updateProductionDetails()">
    </div>
    
    <div id="production_summary" style="display: none;" class="mt-4">
        <div class="alert alert-info">
            <h5 class="mb-0">סה"כ יחידות לייצור: <span id="total_units_display" class="fw-bold">0</span></h5>
        </div>
        
        <h5 class="mt-4">פירוט צריכת חומרים והכנות</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered bg-light">
                <thead>
                    <tr>
                        <th>רכיב</th>
                        <th>סוג</th>
                        <th>מלאי נוכחי</th>
                        <th>צריכה בייצור זה</th>
                        <th>מלאי לאחר ייצור</th>
                        <th>עלות</th>
                    </tr>
                </thead>
                <tbody id="components_usage_body">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">{{ _('Log Production') }}</button>
</form>

<script>
let currentRecipe = null;

$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%',
        language: { noResults: () => "לא נמצאו תוצאות" }
    });

    // Handle product selection change
    $('#product_id').on('change', function () { // Use 'change' event for Select2
        const productId = $(this).val(); // Get selected value
        if (productId) {
            fetchRecipeData(productId);
        } else {
            // Clear summary if no product selected
            document.getElementById('production_summary').style.display = 'none';
            currentRecipe = null;
        }
    });

    // If a product is pre-selected (e.g., on page load, if editing or re-rendering with value)
    const initialProductId = $('#product_id').val();
    if (initialProductId) {
        fetchRecipeData(initialProductId);
    }
});

function fetchRecipeData(productId) {
    fetch(`/api/product_recipe/${productId}`)
        .then(response => response.json())
        .then(data => {
            currentRecipe = data;
            updateProductionDetails();
            document.getElementById('production_summary').style.display = 'block';
        })
        .catch(error => console.error('Error loading recipe:', error));
}

function updateProductionDetails() {
    if (!currentRecipe) return;
    
    const qtyInput = document.getElementById('quantity_produced');
    const batches = parseFloat(qtyInput.value) || 0;
    
    // Update Total Units
    const totalUnits = batches * currentRecipe.products_per_recipe;
    document.getElementById('total_units_display').innerText = totalUnits.toFixed(0);
    
    // Update Table
    const tbody = document.getElementById('components_usage_body');
    tbody.innerHTML = '';
    
    let totalRecipeCost = 0;

    currentRecipe.components.forEach(comp => {
        const usage = comp.qty_per_batch * batches;
        const stockAfter = comp.current_stock - usage;
        const cost = usage * comp.cost_per_unit;
        totalRecipeCost += cost;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${comp.name}</td>
            <td>${comp.type === 'Raw Material' ? 'חומר גלם' : 'הכנה'}</td>
            <td>${comp.current_stock.toFixed(2)} ${comp.unit}</td>
            <td class="fw-bold">${usage.toFixed(2)} ${comp.unit}</td>
            <td class="${stockAfter < 0 ? 'text-danger fw-bold' : ''}">${stockAfter.toFixed(2)} ${comp.unit}</td>
            <td>${cost.toFixed(2)} ₪</td>
        `;
        tbody.appendChild(tr);
    });

    // Add total cost row
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="5" class="text-end fw-bold">סה"כ עלות ייצור</td>
        <td class="fw-bold">${totalRecipeCost.toFixed(2)} ₪</td>
    `;
    tbody.appendChild(totalRow);

}
</script>

<hr>

<!-- Display Recent Production Logs -->
<h2>{{ _('Recent Production Logs') }}</h2>
<table class="table table-bordered table-hover">
    <thead class="thead-dark">
    <tr>
        <th>{{ _('Date') }}</th>
        <th>{{ _('Product') }}</th>
        <th>{{ _('Quantity Produced') }}</th>
    </tr>
    </thead>
    <tbody>
    {% for log in production_logs %}
    <tr>
        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ log.product.name }}</td>
        <td>{{ log.quantity_produced }}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}
