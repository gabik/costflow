{% extends "base.html" %}
{% block title %}{{ _('Production Logs') }}{% endblock %}
{% block content %}
<h1>{{ _('Production Logs') }}</h1>

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Form to Log New Production -->
<form method="POST" class="p-4 bg-white border rounded shadow-sm">
    <div class="form-group">
        <label for="timestamp">{{ _('Timestamp') }}</label>
        <input type="datetime-local" id="timestamp" name="timestamp" class="form-control" value="{{ current_time }}" required>
    </div>
    <div class="form-group mb-3">
        <label for="product_id" class="form-label">{{ _('Select Product') }}</label>
        <select id="product_id" name="product_id" class="form-select select2" required>
            <option value="" disabled selected>בחר מוצר...</option>
            {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group mb-3">
        <label for="quantity_produced">{{ _('Quantity Produced') }} (מספר באצ'ים)</label>
        <input type="number" id="quantity_produced" name="quantity_produced" class="form-control" step="1" required oninput="updateProductionDetails()">
    </div>
    
    <div id="production_summary" style="display: none;" class="mt-4">
        <div class="alert alert-info">
            <h5 class="mb-0">סה"כ יחידות לייצור: <span id="total_units_display" class="fw-bold">0</span></h5>
        </div>
        
        <h5 class="mt-4">פירוט צריכת חומרים והכנות</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered bg-light">
                <thead>
                    <tr>
                        <th>רכיב</th>
                        <th>סוג</th>
                        <th>מלאי נוכחי</th>
                        <th>צריכה בייצור זה</th>
                        <th>מלאי לאחר ייצור</th>
                        <th>עלות יחידה</th>
                        <th>עלות</th>
                    </tr>
                </thead>
                <tbody id="components_usage_body">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">{{ _('Log Production') }}</button>
</form>

<hr>

<!-- Display Recent Production Logs -->
<h2>{{ _('Recent Production Logs') }}</h2>
<table class="table table-bordered table-hover">
    <thead class="thead-dark">
    <tr>
        <th>{{ _('Date') }}</th>
        <th>{{ _('Product') }}</th>
        <th>{{ _('Quantity Produced') }}</th>
        <th>{{ _('Actions') }}</th>
    </tr>
    </thead>
    <tbody>
    {% for log in production_logs %}
    <tr>
        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ log.product.name }}</td>
        <td>{{ "%.2f"|format(log.quantity_produced) }}</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProductionModal" 
                    data-log-id="{{ log.id }}" data-product-name="{{ log.product.name }}" data-quantity="{{ log.quantity_produced }}">
                {{ _('Edit') }}
            </button>
            <form action="{{ url_for('production.delete_production_log', log_id=log.id) }}" method="POST" class="d-inline" onsubmit="return confirm('{{ _('Are you sure you want to delete this production log?') }}');">
                <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Edit Production Modal -->
<div class="modal fade" id="editProductionModal" tabindex="-1" aria-labelledby="editProductionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editProductionForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductionModalLabel">{{ _('Edit Production Quantity') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_product_name" class="form-label">{{ _('Product') }}</label>
                        <input type="text" class="form-control" id="edit_product_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit_quantity_produced" class="form-label">{{ _('Quantity Produced') }} (מספר באצ'ים)</label>
                        <input type="number" class="form-control" id="edit_quantity_produced" name="quantity_produced" step="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save Changes') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentRecipe = null;

$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%',
        language: { noResults: () => "לא נמצאו תוצאות" }
    });

    // Handle product selection change using Select2 specific event
    $('#product_id').on('select2:select', function (e) {
        const productId = e.params.data.id;
        if (productId) {
            fetchRecipeData(productId);
        }
    });
    
    // Fallback for direct changes or browser autofill
    $('#product_id').on('change', function () {
        const productId = $(this).val();
        if (productId && !currentRecipe) { // Only fetch if not already loaded
             fetchRecipeData(productId);
        }
    });

    // If a product is pre-selected (e.g., on page load, if editing or re-rendering with value)
    const initialProductId = $('#product_id').val();
    if (initialProductId) {
        fetchRecipeData(initialProductId);
    }

    // Handle Edit Production Modal show event
    var editProductionModal = document.getElementById('editProductionModal');
    editProductionModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget; // Button that triggered the modal
        var logId = button.getAttribute('data-log-id');
        var productName = button.getAttribute('data-product-name');
        var quantity = button.getAttribute('data-quantity');

        var modalTitle = editProductionModal.querySelector('.modal-title');
        var editProductNameInput = editProductionModal.querySelector('#edit_product_name');
        var editQuantityInput = editProductionModal.querySelector('#edit_quantity_produced');
        var editForm = editProductionModal.querySelector('#editProductionForm');

        modalTitle.textContent = `{{ _('Edit Production Quantity for') }} ${productName}`;
        editProductNameInput.value = productName;
        editQuantityInput.value = quantity;
        editForm.action = `{{ url_for('production.edit_production_log', log_id=0) }}`.replace('0', logId);
    });
});

function fetchRecipeData(productId) {
    console.log('Fetching recipe for product:', productId);
    fetch(`/api/product_recipe/${productId}`)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            currentRecipe = data;
            updateProductionDetails();
            document.getElementById('production_summary').style.display = 'block';
        })
        .catch(error => console.error('Error loading recipe:', error));
}

function updateProductionDetails() {
    if (!currentRecipe) return;
    
    const qtyInput = document.getElementById('quantity_produced');
    const batches = parseFloat(qtyInput.value) || 0;
    
    // Update Total Units
    const totalUnits = batches * currentRecipe.products_per_recipe;
    document.getElementById('total_units_display').innerText = totalUnits.toFixed(0);
    
    // Update Table
    const tbody = document.getElementById('components_usage_body');
    tbody.innerHTML = '';
    
    let totalRecipeCost = 0;

    currentRecipe.components.forEach(comp => {
        const usage = comp.qty_per_batch * batches;
        const stockAfter = comp.current_stock - usage;
        const cost = usage * comp.cost_per_unit;
        totalRecipeCost += cost;

        // Show supplier breakdown if available
        let supplierInfo = '';
        if (comp.suppliers && comp.suppliers.length > 0) {
            supplierInfo = '<small class="text-muted d-block">';
            comp.suppliers.forEach(sup => {
                if (sup.is_primary) {
                    supplierInfo += `${sup.name} (ראשי): ${sup.stock.toFixed(2)}<br>`;
                } else {
                    supplierInfo += `${sup.name}: ${sup.stock.toFixed(2)}<br>`;
                }
            });
            supplierInfo += '</small>';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${comp.name}${supplierInfo}</td>
            <td>${comp.type === 'Raw Material' ? 'חומר גלם' : 'הכנה'}</td>
            <td>${comp.current_stock.toFixed(2)} ${comp.unit}</td>
            <td class="fw-bold">${usage.toFixed(2)} ${comp.unit}</td>
            <td class="${stockAfter < 0 ? 'text-danger fw-bold' : ''}">${stockAfter.toFixed(2)} ${comp.unit}</td>
            <td>${comp.cost_per_unit.toFixed(2)} ₪</td>
            <td>${cost.toFixed(2)} ₪</td>
        `;
        tbody.appendChild(tr);
    });

    // Add total cost row
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="6" class="text-end fw-bold">סה"כ עלות ייצור</td>
        <td class="fw-bold">${totalRecipeCost.toFixed(2)} ₪</td>
    `;
    tbody.appendChild(totalRow);

}
</script>
{% endblock %}