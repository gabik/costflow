{% extends "base.html" %}
{% block title %}{{ _('Production Logs') }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ _('Production Logs') }}</h1>
    <a href="{{ url_for('production.daily_product_production') }}" class="btn btn-outline-primary">
        <i class="bi bi-calendar-day me-2"></i>{{ _('Daily Production') }}
    </a>
</div>

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Form to Log New Production -->
<form method="POST" class="p-4 bg-white border rounded shadow-sm">
    <div class="form-group">
        <label for="timestamp">{{ _('Timestamp') }}</label>
        <input type="datetime-local" id="timestamp" name="timestamp" class="form-control" value="{{ current_time }}" required>
    </div>
    <div class="form-group mb-3">
        <label for="product_id" class="form-label">{{ _('Select Product') }}</label>
        <select id="product_id" name="product_id" class="form-select select2" required>
            <option value="" disabled selected>{{ _('Select product...') }}</option>
            {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group mb-3">
        <label class="form-label">{{ _('Production Mode') }}</label>
        <div class="btn-group w-100" role="group" aria-label="Production mode">
            <input type="radio" class="btn-check" name="production_mode" id="mode_batches" value="batches" checked>
            <label class="btn btn-outline-primary" for="mode_batches">
                <i class="bi bi-stack me-1"></i> {{ _('Batches') }}
            </label>
            <input type="radio" class="btn-check" name="production_mode" id="mode_units" value="units">
            <label class="btn btn-outline-primary" for="mode_units">
                <i class="bi bi-box-seam me-1"></i> {{ _('Units') }}
            </label>
        </div>
    </div>

    <div class="form-group mb-3">
        <label for="quantity_produced" id="quantity_label">{{ _('Quantity Produced') }} ({{ _('number of batches') }})</label>
        <input type="number" id="quantity_produced" name="quantity_produced" class="form-control" step="0.01" required>
        <div class="form-text" id="quantity_help_text" style="display: none;"></div>
    </div>
    
    <div id="production_summary" style="display: none;" class="mt-4">
        <div class="alert alert-info">
            <h5 class="mb-0">{{ _('Total units to produce:') }} <span id="total_units_display" class="fw-bold">0</span></h5>
        </div>

        <h5 class="mt-4">{{ _('Material and Premake Usage Breakdown') }}</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered bg-light">
                <thead>
                    <tr>
                        <th>{{ _('Component') }}</th>
                        <th>{{ _('Type') }}</th>
                        <th>{{ _('Current Stock') }}</th>
                        <th>{{ _('Usage in this production') }}</th>
                        <th>{{ _('Stock after production') }}</th>
                        <th>{{ _('Cost per 100g/unit') }}</th>
                        <th>{{ _('Total Cost') }}</th>
                    </tr>
                </thead>
                <tbody id="components_usage_body">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">{{ _('Log Production') }}</button>
</form>

<hr>

<!-- Display Recent Production Logs -->
<h2>{{ _('Recent Production Logs') }}</h2>
<table class="table table-bordered table-hover">
    <thead class="thead-dark">
    <tr>
        <th>{{ _('Date') }}</th>
        <th>{{ _('Product') }}</th>
        <th>{{ _('Batches') }}</th>
        <th>{{ _('Units Produced') }}</th>
        <th>{{ _('Total Cost') }}</th>
        <th>{{ _('Cost/Unit') }}</th>
        <th>{{ _('Actions') }}</th>
    </tr>
    </thead>
    <tbody>
    {% for log in production_logs %}
    <tr>
        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ log.product.name }}</td>
        <td>{{ "%.2f"|format(log.quantity_produced) }}</td>
        <td>{{ "%.0f"|format(log.quantity_produced * log.product.products_per_recipe) }}</td>
        <td>₪{{ "%.2f"|format(log.total_cost or 0) }}</td>
        <td>₪{{ "%.2f"|format(log.cost_per_unit or 0) }}</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProductionModal"
                    data-log-id="{{ log.id }}" data-product-name="{{ log.product.name }}" data-quantity="{{ log.quantity_produced }}">
                {{ _('Edit') }}
            </button>
            <form action="{{ url_for('production.delete_production_log', log_id=log.id) }}" method="POST" class="d-inline" onsubmit="return confirm('{{ _('Are you sure you want to delete this production log?') }}');">
                <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Edit Production Modal -->
<div class="modal fade" id="editProductionModal" tabindex="-1" aria-labelledby="editProductionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editProductionForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductionModalLabel">{{ _('Edit Production Quantity') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_product_name" class="form-label">{{ _('Product') }}</label>
                        <input type="text" class="form-control" id="edit_product_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit_quantity_produced" class="form-label">{{ _('Quantity Produced') }} ({{ _('number of batches') }})</label>
                        <input type="number" class="form-control" id="edit_quantity_produced" name="quantity_produced" step="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save Changes') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentRecipe = null;

$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%',
        language: { noResults: () => "{{ _('No results found') }}" }
    });

    // Add event listener for quantity input
    $('#quantity_produced').on('input', function() {
        updateProductionDetails();
    });

    // Add event listeners for production mode radio buttons
    $('input[name="production_mode"]').on('change', function() {
        updateProductionMode();
    });

    // Handle product selection change using Select2 specific event
    $('#product_id').on('select2:select', function (e) {
        const productId = e.params.data.id;
        if (productId) {
            fetchRecipeData(productId);
        }
    });
    
    // Fallback for direct changes or browser autofill
    $('#product_id').on('change', function () {
        const productId = $(this).val();
        if (productId && !currentRecipe) { // Only fetch if not already loaded
             fetchRecipeData(productId);
        }
    });

    // If a product is pre-selected (e.g., on page load, if editing or re-rendering with value)
    const initialProductId = $('#product_id').val();
    if (initialProductId) {
        fetchRecipeData(initialProductId);
    }

    // Handle Edit Production Modal show event
    var editProductionModal = document.getElementById('editProductionModal');
    editProductionModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget; // Button that triggered the modal
        var logId = button.getAttribute('data-log-id');
        var productName = button.getAttribute('data-product-name');
        var quantity = button.getAttribute('data-quantity');

        var modalTitle = editProductionModal.querySelector('.modal-title');
        var editProductNameInput = editProductionModal.querySelector('#edit_product_name');
        var editQuantityInput = editProductionModal.querySelector('#edit_quantity_produced');
        var editForm = editProductionModal.querySelector('#editProductionForm');

        modalTitle.textContent = `{{ _('Edit Production Quantity for') }} ${productName}`;
        editProductNameInput.value = productName;
        editQuantityInput.value = quantity;
        editForm.action = `{{ url_for('production.edit_production_log', log_id=0) }}`.replace('0', logId);
    });
});

function fetchRecipeData(productId) {
    const inputValue = parseFloat(document.getElementById('quantity_produced').value) || 1;
    const modeUnits = document.getElementById('mode_units').checked;

    // Convert to batches if in units mode
    let batches;
    if (modeUnits && currentRecipe) {
        batches = inputValue / currentRecipe.products_per_recipe;
    } else {
        batches = inputValue;
    }

    fetch(`/api/product_recipe/${productId}?quantity=${batches}&t=${Date.now()}`)  // Add cache busting
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            currentRecipe = data;
            currentRecipe.fetched_quantity = batches; // Track what quantity this data is for
            updateProductionDetails();
            document.getElementById('production_summary').style.display = 'block';
        })
        .catch(error => console.error('Error loading recipe:', error));
}

function updateProductionMode() {
    const modeUnits = document.getElementById('mode_units').checked;
    const modeBatches = document.getElementById('mode_batches').checked;
    const label = document.getElementById('quantity_label');
    const helpText = document.getElementById('quantity_help_text');
    const qtyInput = document.getElementById('quantity_produced');

    if (modeUnits) {
        label.innerHTML = {{ _("Quantity Produced")|tojson }} + ' (' + {{ _("number of units")|tojson }} + ')';
        if (currentRecipe) {
            helpText.innerHTML = {{ _("One unit")|tojson }} + ' = 1/' + currentRecipe.products_per_recipe + ' ' + {{ _("batches")|tojson }};
            helpText.style.display = 'block';
        }
    } else {
        label.innerHTML = {{ _("Quantity Produced")|tojson }} + ' (' + {{ _("number of batches")|tojson }} + ')';
        helpText.style.display = 'none';
    }

    // Recalculate display when mode changes
    updateProductionDetails();
}

// Helper function to format quantity with dynamic units
function formatQuantityWithUnit(quantity, unit) {
    // If unit is kg and quantity is less than 1, convert to grams
    if (unit.toLowerCase() === 'kg' && quantity < 1 && quantity > 0) {
        return `${(quantity * 1000).toFixed(1)} g`;
    }
    // For other units or quantities >= 1kg, keep original
    return `${quantity.toFixed(2)} ${unit}`;
}

function updateProductionDetails() {
    if (!currentRecipe) return;

    const qtyInput = document.getElementById('quantity_produced');
    const modeUnits = document.getElementById('mode_units').checked;
    const inputValue = parseFloat(qtyInput.value) || 0;

    // Calculate batches based on mode
    let batches;
    if (modeUnits) {
        // User entered units, convert to batches
        batches = inputValue / currentRecipe.products_per_recipe;
    } else {
        // User entered batches directly
        batches = inputValue;
    }

    // Update Total Units
    const totalUnits = batches * currentRecipe.products_per_recipe;
    document.getElementById('total_units_display').innerText = totalUnits.toFixed(0);

    // If quantity changed, fetch updated breakdown
    if (batches > 0 && (!currentRecipe.fetched_quantity || currentRecipe.fetched_quantity !== batches)) {
        const productId = document.getElementById('product_id').value;
        if (productId) {
            fetchRecipeData(productId);
            return;
        }
    }

    // Update Table
    const tbody = document.getElementById('components_usage_body');
    tbody.innerHTML = '';

    let totalRecipeCost = 0;

    currentRecipe.components.forEach(comp => {
        if (comp.type === 'Raw Material' && comp.consumption_breakdown && comp.consumption_breakdown.length > 0) {
            // Use new consumption breakdown for raw materials
            const consumptionRows = comp.consumption_breakdown.filter(c => c.amount_to_consume > 0 || c.is_primary);

            if (consumptionRows.length === 1 && !consumptionRows[0].is_deficit) {
                // Single supplier case - show material name without supplier
                const consumption = consumptionRows[0];
                const tr = document.createElement('tr');
                // Add discount indicator if applicable - show cost per 100g
                // Raw materials cost_per_unit is already per 100g from backend
                let costDisplay = `${consumption.cost_per_unit.toFixed(2)} ₪`;
                if (consumption.original_cost && consumption.cost_per_unit < consumption.original_cost) {
                    const discountPercent = Math.round((1 - consumption.cost_per_unit/consumption.original_cost) * 100);
                    costDisplay = `<span class="text-decoration-line-through text-muted">${consumption.original_cost.toFixed(2)} ₪</span> <strong class="text-success">${consumption.cost_per_unit.toFixed(2)} ₪</strong> <span class="badge bg-success">-${discountPercent}%</span>`;
                }
                // Check if material has waste percentage for tooltips
                let usageDisplay = formatQuantityWithUnit(consumption.amount_to_consume, comp.unit);
                let costTooltip = '';
                if (comp.waste_percentage > 0) {
                    // Recipe needs the original amount (comp.qty_per_batch * batches)
                    const recipeNeeds = comp.qty_per_batch * batches;
                    usageDisplay = `<span data-bs-toggle="tooltip"
                                         data-bs-placement="top"
                                         title="{{ _('Recipe needs') }}: ${formatQuantityWithUnit(recipeNeeds, comp.unit)}, {{ _('using') }} ${formatQuantityWithUnit(consumption.amount_to_consume, comp.unit)} ({{ _('includes') }} ${comp.waste_percentage}% {{ _('waste') }})"
                                         class="text-decoration-underline" style="text-decoration-style: dotted !important; cursor: help;">
                                         ${formatQuantityWithUnit(consumption.amount_to_consume, comp.unit)}
                                         <i class="bi bi-info-circle-fill text-warning small ms-1"></i>
                                    </span>`;
                    costTooltip = `data-bs-toggle="tooltip" data-bs-placement="top" title="{{ _('Includes') }} ${comp.waste_percentage}% {{ _('waste adjustment') }}"`;
                }

                tr.innerHTML = `
                    <td>${comp.name}</td>
                    <td>{{ _('Raw Material') }}</td>
                    <td>${formatQuantityWithUnit(consumption.stock_available, comp.unit)}</td>
                    <td class="fw-bold">${usageDisplay}</td>
                    <td class="${consumption.remaining_after < 0 ? 'text-danger fw-bold' : ''}">${formatQuantityWithUnit(consumption.remaining_after, comp.unit)}</td>
                    <td ${costTooltip}>${costDisplay}</td>
                    <td>${consumption.total_cost.toFixed(2)} ₪</td>
                `;
                tbody.appendChild(tr);
                totalRecipeCost += consumption.total_cost;

                // Initialize tooltips for newly added elements
                setTimeout(() => {
                    const tooltipElements = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
                    tooltipElements.forEach(el => new bootstrap.Tooltip(el));
                }, 100);
            } else {
                // Multiple suppliers or deficit case - show separate rows
                consumptionRows.forEach((consumption, index) => {
                    const tr = document.createElement('tr');
                    let nameDisplay = '';

                    if (index === 0) {
                        // First row shows material name with supplier
                        nameDisplay = `${comp.name} <small class="text-muted">(${consumption.supplier_name})</small>`;
                    } else {
                        // Additional rows show indented supplier name
                        nameDisplay = `<span class="ms-3">└─ ${consumption.supplier_name}</span>`;
                    }

                    // Add warning badge for deficit
                    if (consumption.is_deficit) {
                        nameDisplay += ' <span class="badge bg-danger ms-1">{{ _('Shortage') }}</span>';
                    }

                    // Add discount indicator if applicable - show cost per 100g
                    // Raw materials cost_per_unit is already per 100g from backend
                    let costDisplay = `${consumption.cost_per_unit.toFixed(2)} ₪`;
                    if (consumption.original_cost && consumption.cost_per_unit < consumption.original_cost) {
                        const discountPercent = Math.round((1 - consumption.cost_per_unit/consumption.original_cost) * 100);
                        costDisplay = `<span class="text-decoration-line-through text-muted">${consumption.original_cost.toFixed(2)} ₪</span> <strong class="text-success">${consumption.cost_per_unit.toFixed(2)} ₪</strong> <span class="badge bg-success">-${discountPercent}%</span>`;
                    }

                    // Check if material has waste percentage for tooltips (only show on first row)
                    let usageDisplay = formatQuantityWithUnit(consumption.amount_to_consume, comp.unit);
                    let costTooltip = '';
                    if (index === 0 && comp.waste_percentage > 0) {
                        // Recipe needs the original amount (comp.qty_per_batch * batches)
                        const recipeNeeds = comp.qty_per_batch * batches;
                        usageDisplay = `<span data-bs-toggle="tooltip"
                                             data-bs-placement="top"
                                             title="{{ _('Recipe needs') }}: ${formatQuantityWithUnit(recipeNeeds, comp.unit)}, {{ _('using') }} ${formatQuantityWithUnit(consumption.amount_to_consume, comp.unit)} ({{ _('includes') }} ${comp.waste_percentage}% {{ _('waste') }})"
                                             class="text-decoration-underline" style="text-decoration-style: dotted !important; cursor: help;">
                                             ${formatQuantityWithUnit(consumption.amount_to_consume, comp.unit)}
                                             <i class="bi bi-info-circle-fill text-warning small ms-1"></i>
                                        </span>`;
                        costTooltip = `data-bs-toggle="tooltip" data-bs-placement="top" title="{{ _('Includes') }} ${comp.waste_percentage}% {{ _('waste adjustment') }}"`;
                    }

                    tr.innerHTML = `
                        <td>${nameDisplay}</td>
                        <td>${index === 0 ? '{{ _("Raw Material") }}' : ''}</td>
                        <td>${formatQuantityWithUnit(consumption.stock_available, comp.unit)}</td>
                        <td class="fw-bold">${usageDisplay}</td>
                        <td class="${consumption.remaining_after < 0 ? 'text-danger fw-bold' : ''}">${formatQuantityWithUnit(consumption.remaining_after, comp.unit)}</td>
                        <td ${costTooltip}>${costDisplay}</td>
                        <td>${consumption.total_cost.toFixed(2)} ₪</td>
                    `;
                    tbody.appendChild(tr);
                    totalRecipeCost += consumption.total_cost;

                    // Initialize tooltips for newly added elements
                    setTimeout(() => {
                        const tooltipElements = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
                        tooltipElements.forEach(el => new bootstrap.Tooltip(el));
                    }, 100);
                });
            }
        } else {
            // Fallback for premakes, preproducts, unlimited materials, or old data structure
            const usage = comp.qty_per_batch * batches;
            const cost = usage * comp.cost_per_unit;
            totalRecipeCost += cost;

            // Handle unlimited materials
            const isUnlimited = comp.is_unlimited || comp.current_stock === null;
            let currentStockDisplay, stockAfterDisplay;
            let stockAfter = 0;

            if (isUnlimited) {
                currentStockDisplay = '<span class="badge bg-primary fs-6">∞</span>';
                stockAfterDisplay = '<span class="badge bg-primary fs-6">∞</span>';
            } else {
                stockAfter = comp.current_stock - usage;
                currentStockDisplay = formatQuantityWithUnit(comp.current_stock, comp.unit);
                stockAfterDisplay = formatQuantityWithUnit(stockAfter, comp.unit);
            }

            // Check for deficit (not applicable for unlimited materials)
            const hasDeficit = !isUnlimited && (comp.is_deficit || stockAfter < 0);
            let nameDisplay = comp.name;
            if (hasDeficit) {
                nameDisplay += ' <span class="badge bg-danger ms-1">{{ _('Shortage') }}</span>';
            }

            const tr = document.createElement('tr');
            let typeDisplay;
            if (comp.type === 'Raw Material') {
                typeDisplay = '{{ _("Raw Material") }}';
            } else if (comp.type === 'Preproduct') {
                typeDisplay = '{{ _("Preproduct") }}';
            } else if (comp.type === 'Packaging') {
                typeDisplay = '{{ _("Packaging") }}';
            } else {
                typeDisplay = '{{ _("Premake") }}';
            }

            // Special handling for preproducts and cost display
            let costDisplay, actualCost;
            if (comp.type === 'Preproduct') {
                // Preproducts can be weight-based or unit-based
                if (comp.unit === 'kg' || comp.unit === 'g') {
                    // Weight-based preproduct - show cost per 100g
                    let costPer100g;
                    if (comp.cost_per_100g !== null && comp.cost_per_100g !== undefined) {
                        costPer100g = comp.cost_per_100g;
                    } else {
                        // Convert from native unit to per 100g
                        if (comp.unit === 'kg') {
                            costPer100g = comp.cost_per_unit / 10;  // Convert from per kg to per 100g
                        } else {  // unit is 'g'
                            costPer100g = comp.cost_per_unit * 100;  // Convert from per g to per 100g
                        }
                    }
                    costDisplay = `${costPer100g.toFixed(2)} ₪`;

                    // Calculate actual cost based on usage in grams
                    let usageInGrams;
                    if (comp.unit === 'kg') {
                        usageInGrams = usage * 1000;
                    } else {
                        usageInGrams = usage;
                    }
                    actualCost = (usageInGrams / 100) * costPer100g;
                } else {
                    // Unit-based preproduct (pieces, etc.) - show cost per unit
                    costDisplay = `${comp.cost_per_unit.toFixed(2)} ₪ <small class="text-muted">/ ${comp.unit || 'unit'}</small>`;
                    actualCost = cost;
                }
            } else if (comp.type === 'Premake') {
                // For premakes, comp.cost_per_unit is per kg, convert to per 100g
                const costPer100g = comp.cost_per_unit / 10;  // Convert from per kg to per 100g
                costDisplay = `${costPer100g.toFixed(2)} ₪`;
                actualCost = cost;
            } else if (comp.type === 'Packaging') {
                // For packaging, show cost per unit
                costDisplay = `${comp.cost_per_unit.toFixed(2)} ₪ <small class="text-muted">/ unit</small>`;
                actualCost = cost;
            } else {
                // For raw materials or others, show as is (already per 100g from backend)
                costDisplay = `${comp.cost_per_unit.toFixed(2)} ₪`;
                actualCost = cost;
            }

            tr.innerHTML = `
                <td>${nameDisplay}</td>
                <td>${typeDisplay}</td>
                <td>${currentStockDisplay}</td>
                <td class="fw-bold">${formatQuantityWithUnit(usage, comp.unit)}</td>
                <td class="${!isUnlimited && stockAfter < 0 ? 'text-danger fw-bold' : ''}">${stockAfterDisplay}</td>
                <td>${costDisplay}</td>
                <td>${actualCost.toFixed(2)} ₪</td>
            `;
            tbody.appendChild(tr);
        }
    });

    // Add total cost row
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="6" class="text-end fw-bold">{{ _('Total production cost') }}</td>
        <td class="fw-bold">${totalRecipeCost.toFixed(2)} ₪</td>
    `;
    tbody.appendChild(totalRow);

}
</script>
{% endblock %}