{% extends "base.html" %}
{% block title %}{{ _('Review Recipes for Import') }} - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">{{ _('Review Recipes for Import') }}</h1>
        <p class="text-secondary">
            {{ _('Type:') }} <span class="badge bg-info">{{ metadata.type }}</span> |
            {{ _('Category:') }} <strong>{{ category.name }}</strong> |
            {{ _('Unit:') }} <strong>{{ metadata.unit }}</strong> |
            {{ _('Total recipes:') }} <strong>{{ recipes|length }}</strong>
        </p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category_msg, message in messages %}
      <div class="alert alert-{{ 'danger' if category_msg == 'error' else category_msg }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


<!-- Missing Materials Warning -->
{% if has_missing_materials %}
<div class="alert alert-danger" role="alert">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="alert-heading mb-0">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ _('Missing materials in system!') }}
        </h5>
        <button class="btn btn-sm btn-link text-danger p-0" type="button" data-bs-toggle="collapse" data-bs-target="#missingMaterialsList" aria-expanded="false">
            <i class="bi bi-chevron-down" id="missingMaterialsToggleIcon"></i>
        </button>
    </div>
    <div class="collapse" id="missingMaterialsList">
        <hr class="mt-2">
        <p>{{ _('Select a match for missing materials from the dropdown, or add the materials to the system:') }}</p>
        <ul class="mb-3">
            {% for material in missing_materials %}
            <li><strong>{{ material.name }}</strong> ({{ material.type }})</li>
            {% endfor %}
        </ul>
        <p class="mb-0">
            <i class="bi bi-lightbulb me-2"></i>
            {{ _('Select a material from the dropdown or add new materials to the system and then import again.') }}
        </p>
    </div>
</div>
{% endif %}

<!-- Supplier Creation Section (hidden by default, shown when needed) -->
<div id="supplierCreationSection" class="mb-4" style="display:none;">
    <div id="supplierCreationContainer"></div>
</div>

<!-- Recipes Review -->
<form method="POST" action="{{ url_for('recipe_import.confirm_import') }}" id="recipeImportForm">

<!-- Recipe Selection Controls -->
<div class="mb-3 d-flex justify-content-between align-items-center">
    <button type="button" class="btn btn-sm btn-outline-primary" id="toggleAllRecipes">
        <i class="bi bi-check-square me-1"></i> {{ _('Select All') }}
    </button>
    <span class="text-muted" id="selectedCount">{{ _('0 recipes selected') }}</span>
</div>

<div class="accordion" id="recipesAccordion">
    {% for recipe in recipes %}
    {% set recipe_idx = loop.index0 %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ loop.index }}">
            <div class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                 style="cursor: pointer;"
                 aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                 aria-controls="collapse{{ loop.index }}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <input type="checkbox"
                               name="import_recipe{{ recipe_idx }}"
                               value="1"
                               class="form-check-input recipe-select-checkbox"
                               id="recipeCheckbox{{ recipe_idx }}"
                               data-recipe-idx="{{ recipe_idx }}"
                               data-has-missing="{{ recipe.has_missing|lower }}"
                               onclick="event.stopPropagation();">
                        <span class="fw-bold mb-0 recipe-name-label"
                              style="cursor: pointer;"
                              data-bs-toggle="collapse"
                              data-bs-target="#collapse{{ loop.index }}">{{ recipe.name }}</span>
                    </div>
                    <div class="d-flex gap-2 me-3">
                        {% if recipe.exists %}
                            {% if recipe.has_actual_changes %}
                                <span class="badge bg-warning">{{ _('Exists - Will Update') }}</span>
                            {% elif recipe.has_price_only %}
                                <span class="badge bg-info bg-opacity-50" title="{{ _('Price differences only - no recipe changes') }}">
                                    <i class="bi bi-tag"></i> {{ _('Price Info') }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">{{ _('Exists - No Changes') }}</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-success">{{ _('New') }}</span>
                        {% endif %}
                        {% if recipe.has_missing %}
                        <span class="badge bg-danger">{{ _('Missing Materials') }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </h2>
        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
             aria-labelledby="heading{{ loop.index }}" data-bs-parent="#recipesAccordion">
            <div class="accordion-body">

                <!-- Materials Table -->
                <h6 class="fw-bold mb-3">{{ _('Materials:') }}</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>{{ _('Name') }}</th>
                                <th>{{ _('Type') }}</th>
                                <th style="min-width: 300px;">{{ _('Status') }}</th>
                                <th>{{ _('Weight (g)') }}</th>
                                <th>{{ _('Price in Sheet') }}</th>
                                <th>{{ _('Price in System') }}</th>
                                <th>{{ _('Match') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in recipe.materials %}
                            {% set mat_idx = loop.index0 %}
                            <tr class="material-row {% if not material.found %}table-danger{% endif %}"
                                data-recipe-idx="{{ recipe_idx }}"
                                data-material-idx="{{ mat_idx }}"
                                data-material-name="{{ material.name }}"
                                data-material-type="{{ material.type }}"
                                data-sheet-price="{{ material.sheet_price }}">
                                <td>
                                    <div class="material-header d-flex justify-content-between align-items-center">
                                        <strong>{{ material.name }}</strong>
                                        {% if not material.found %}
                                        <button class="btn btn-sm btn-link expand-create-btn p-0" type="button">
                                            <i class="bi bi-chevron-down"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% if not material.found %}
                                    <div class="material-create-form mt-2" style="display:none;">
                                        <!-- Create/Map toggle -->
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input create-toggle"
                                                   id="createToggle_{{ recipe_idx }}_{{ mat_idx }}">
                                            <label class="form-check-label" for="createToggle_{{ recipe_idx }}_{{ mat_idx }}">
                                                {{ _('Create New Material') }}
                                            </label>
                                        </div>
                                        <!-- Creation fields (hidden by default) -->
                                        <div class="create-fields" style="display:none;">
                                            <div class="row g-2">
                                                <div class="col-md-4">
                                                    <label class="form-label small">{{ _('Category') }}</label>
                                                    <select class="form-select form-select-sm category-select">
                                                        <option value="">{{ _('Select...') }}</option>
                                                        {% for cat in all_categories %}
                                                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label small">{{ _('Unit') }}</label>
                                                    <select class="form-select form-select-sm unit-select">
                                                        <option value="kg" selected>kg</option>
                                                        <option value="L">L</option>
                                                        <option value="piece">piece</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label small">{{ _('Supplier') }}</label>
                                                    <div class="input-group input-group-sm">
                                                        <select class="form-select supplier-select">
                                                            <option value="">{{ _('Select...') }}</option>
                                                            <option value="new">➕ {{ _('New Supplier...') }}</option>
                                                            {% for supplier in all_suppliers %}
                                                            <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row g-2 mt-1">
                                                <div class="col-md-4">
                                                    <label class="form-label small">{{ _('SKU (Optional)') }}</label>
                                                    <input type="text" class="form-control form-control-sm sku-input"
                                                           placeholder="{{ _('SKU (Optional)') }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label small">{{ _('Price') }}</label>
                                                    <input type="number" class="form-control form-control-sm price-input"
                                                           value="{{ material.sheet_price }}" step="0.01">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label small">&nbsp;</label>
                                                    <div>
                                                        <button class="btn btn-sm btn-success create-material-btn">
                                                            <i class="bi bi-check-lg me-1"></i>{{ _('Create') }}
                                                        </button>
                                                        <button class="btn btn-sm btn-secondary cancel-create-btn ms-1">
                                                            <i class="bi bi-x me-1"></i>{{ _('Cancel') }}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </td>
                                <td><small class="text-muted">{{ material.type }}</small></td>
                                <td class="material-status-cell">
                                    {% if material.found %}
                                        {% if material.matched_via_alternative %}
                                        <span class="badge bg-info" title="{{ _('Found via alternative name') }}">
                                            <i class="bi bi-tag-fill"></i> {{ _('Found (alternative name)') }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> {{ _('Found') }}</span>
                                        {% endif %}
                                    {% else %}
                                    <!-- Dropdown for mapping missing material -->
                                    <select name="mapping_recipe{{ recipe_idx }}_mat{{ loop.index0 }}"
                                            class="form-select form-select-sm material-mapping-select"
                                            data-material-type="{{ material.type }}"
                                            data-sheet-price="{{ material.sheet_price }}"
                                            data-recipe-idx="{{ recipe_idx }}"
                                            data-material-idx="{{ loop.index0 }}">
                                        <option value="">{{ _('Select material from system...') }}</option>

                                        {% if material.type == 'חומר גלם' %}
                                            {% for rm in all_raw_materials %}
                                            <option value="{{ rm.id }}">
                                                {{ rm.name }} ({{ rm.unit }})
                                            </option>
                                            {% endfor %}
                                        {% elif material.type == 'הכנה' %}
                                            {% for pm in all_premakes %}
                                            <option value="{{ pm.id }}">{{ pm.name }}</option>
                                            {% endfor %}
                                        {% elif material.type == 'מוצר מקדים' %}
                                            {% for pp in all_preproducts %}
                                            <option value="{{ pp.id }}">{{ pp.name }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    {% endif %}
                                </td>
                                <td>
                                    <input type="number"
                                           name="weight_recipe{{ recipe_idx }}_mat{{ loop.index0 }}"
                                           class="form-control form-control-sm weight-input"
                                           value="{{ material.weight }}"
                                           step="0.001"
                                           min="0"
                                           required
                                           style="width: 100px;">
                                </td>
                                <td>{{ "%.2f"|format(material.sheet_price) if material.sheet_price else '0.00' }} ₪</td>
                                <td class="db-price-cell">
                                    {% if material.db_price %}
                                        {% if material.price_differs %}
                                        <span class="text-danger">{{ "%.2f"|format(material.db_price) }} ₪</span>
                                        {% else %}
                                        <span>{{ "%.2f"|format(material.db_price) }} ₪</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted mapped-price-placeholder">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if material.found %}
                                        {% if material.price_differs %}
                                        <span class="text-muted small">
                                            <i class="bi bi-tag text-info"></i> {{ _('Price only') }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success"><i class="bi bi-check"></i> {{ _('Same') }}</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Loss Row -->
                            {% if recipe.loss %}
                            <tr class="table-warning">
                                <td><strong>{{ recipe.loss.name }}</strong></td>
                                <td><small class="text-muted">{{ _('Loss') }}</small></td>
                                <td><span class="badge bg-secondary">{{ _('Loss') }}</span></td>
                                <td>{{ "%.3f"|format(recipe.loss.weight) if recipe.loss.weight else '0.000' }}</td>
                                <td colspan="3" class="text-muted"><em>{{ _('No cost') }}</em></td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">{{ _('Weight and Cost Summary:') }}</h6>
                                <ul class="list-unstyled mb-0">
                                    <li><strong>{{ _('Gross Weight:') }}</strong> {{ "%.3f"|format(recipe.total_weight) if recipe.total_weight else '0.000' }} {{ _('g') }}</li>
                                    {% if recipe.loss %}
                                    <li><strong>{{ _('Loss:') }}</strong> {{ "%.3f"|format(recipe.loss.weight) if recipe.loss.weight else '0.000' }} {{ _('g') }}</li>
                                    <li><strong>{{ _('Net Weight:') }}</strong> {{ "%.3f"|format(recipe.net_weight) if recipe.net_weight else '0.000' }} {{ _('g') }}</li>
                                    {% endif %}
                                    <li><strong>{{ _('Total Cost:') }}</strong> {{ "%.2f"|format(recipe.total_cost) if recipe.total_cost else '0.00' }} ₪</li>
                                    <li class="mt-2 text-primary"><strong>{{ _('Cost per 100g:') }}</strong> {{ "%.2f"|format(recipe.cost_100g) if recipe.cost_100g else '0.00' }} ₪</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Diff Display (if exists) -->
                    {% if recipe.exists and recipe.diff %}
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">{{ _('Changes (compared to existing recipe):') }}</h6>
                                <ul class="list-unstyled mb-0">
                                    {% if recipe.diff.added %}
                                    <li class="text-success">
                                        <i class="bi bi-plus-circle"></i> <strong>{{ _('Added:') }}</strong>
                                        {% for mat in recipe.diff.added %}
                                        {{ mat.name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </li>
                                    {% endif %}
                                    {% if recipe.diff.removed %}
                                    <li class="text-danger">
                                        <i class="bi bi-dash-circle"></i> <strong>{{ _('Removed:') }}</strong>
                                        {% for mat in recipe.diff.removed %}
                                        {{ mat.name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </li>
                                    {% endif %}
                                    {% if recipe.diff.changed %}
                                    <li class="text-warning">
                                        <i class="bi bi-arrow-repeat"></i> <strong>{{ _('Quantity Changed:') }}</strong>
                                        {% for item in recipe.diff.changed %}
                                        {{ item.material.name }} ({{ "%.1f"|format(item.old_quantity) if item.old_quantity else '0.0' }} → {{ "%.1f"|format(item.new_quantity) if item.new_quantity else '0.0' }}){% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </li>
                                    {% endif %}
                                    {% if not recipe.diff.added and not recipe.diff.removed and not recipe.diff.changed %}
                                    <li class="text-muted"><i class="bi bi-check-circle"></i> {{ _('No changes') }}</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
</div>
</form>

<!-- Action Buttons -->
<div class="mt-4 d-flex justify-content-end gap-2">
    <a href="{{ url_for('recipe_import.upload_recipes') }}" class="btn btn-secondary">
        <i class="bi bi-x-circle me-2"></i> {{ _('Cancel') }}
    </a>
    <button type="submit" form="recipeImportForm" class="btn btn-success btn-lg" id="confirmImportBtn">
        <i class="bi bi-check-lg me-2"></i> {{ _('Confirm and Import Recipes') }}
    </button>
</div>

<div class="alert alert-info mt-3" id="mappingInfoAlert" style="display:none;">
    <i class="bi bi-info-circle me-2"></i>
    <span id="mappingInfoText"></span>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Recipe Import JavaScript -->
<script src="{{ url_for('static', filename='js/recipe_import.js') }}"></script>
<script>
// Make these variables global so they can be accessed from recipe_import.js
let recipeMaterialStatus = new Map();
let updateSubmitButton = null;
let selectedRecipes = new Set();

$(document).ready(function() {
    // Toggle icon for missing materials collapse
    $('#missingMaterialsList').on('show.bs.collapse', function() {
        $('#missingMaterialsToggleIcon').removeClass('bi-chevron-down').addClass('bi-chevron-up');
    });
    $('#missingMaterialsList').on('hide.bs.collapse', function() {
        $('#missingMaterialsToggleIcon').removeClass('bi-chevron-up').addClass('bi-chevron-down');
    });

    // Handle accordion header clicks (except checkbox and label)
    $('.accordion-button').on('click', function(e) {
        // Only toggle if click was not on checkbox or label
        if (!$(e.target).is('.recipe-select-checkbox') && !$(e.target).is('.recipe-name-label')) {
            const collapseId = $(this).attr('aria-controls');
            $('#' + collapseId).collapse('toggle');
        }
    });

    // Update accordion button state when collapse changes
    $('.accordion-collapse').on('shown.bs.collapse', function() {
        const headerId = $(this).attr('aria-labelledby');
        $('#' + headerId).find('.accordion-button').removeClass('collapsed').attr('aria-expanded', 'true');
    });
    $('.accordion-collapse').on('hidden.bs.collapse', function() {
        const headerId = $(this).attr('aria-labelledby');
        $('#' + headerId).find('.accordion-button').addClass('collapsed').attr('aria-expanded', 'false');
    });

    // Initialize Select2 on material mapping dropdowns
    $('.material-mapping-select').select2({
        theme: 'bootstrap-5',
        dir: 'rtl',
        placeholder: '{{ _("Search material...") }}',
        allowClear: true,
        width: '100%'
    });

    // Track unmapped materials per recipe: Map<recipeIdx, Set<materialIdx>>
    recipeMaterialStatus = new Map();

    // Initialize material tracking from dropdowns
    $('.material-mapping-select').each(function() {
        const recipeIdx = $(this).data('recipe-idx');
        const materialIdx = $(this).data('material-idx');

        if (!recipeMaterialStatus.has(recipeIdx)) {
            recipeMaterialStatus.set(recipeIdx, new Set());
        }
        // Add to unmapped set (since dropdowns only exist for missing materials)
        recipeMaterialStatus.get(recipeIdx).add(materialIdx);
    });

    // Initialize selected recipes (using global variable)
    selectedRecipes = new Set();

    updateSelectedCount();

    // Handle material selection change
    $('.material-mapping-select').on('change', function() {
        const $select = $(this);
        const selectedOption = $select.find(':selected');
        const $row = $select.closest('tr');
        const recipeIdx = $select.data('recipe-idx');
        const materialIdx = $select.data('material-idx');

        if (selectedOption.val()) {
            // Material mapped - remove from unmapped set
            if (recipeMaterialStatus.has(recipeIdx)) {
                recipeMaterialStatus.get(recipeIdx).delete(materialIdx);
            }

            // Remove required attribute when mapped
            $select.prop('required', false);

            // Show mapped material price
            const dbPrice = selectedOption.data('price');
            if (dbPrice !== undefined) {
                const dbPriceNum = parseFloat(dbPrice) || 0;
                const sheetPrice = parseFloat($select.data('sheet-price'));
                const priceDiff = Math.abs(dbPriceNum - sheetPrice) > 0.01;

                // Update price cell
                const priceHtml = dbPriceNum.toFixed(2) + ' ₪';
                const priceClass = priceDiff ? 'text-warning' : 'text-success';
                $row.find('.db-price-cell').html(
                    `<span class="${priceClass}">${priceHtml}</span>`
                );

                // Update row highlight
                if (priceDiff) {
                    $row.removeClass('table-danger').addClass('table-warning');
                } else {
                    $row.removeClass('table-danger');
                }
            }
        } else {
            // Material unmapped - add to unmapped set
            if (!recipeMaterialStatus.has(recipeIdx)) {
                recipeMaterialStatus.set(recipeIdx, new Set());
            }
            recipeMaterialStatus.get(recipeIdx).add(materialIdx);

            // Add required attribute if recipe is selected
            if (selectedRecipes.has(recipeIdx)) {
                $select.prop('required', true);
            }

            $row.addClass('table-danger').removeClass('table-warning');
            $row.find('.db-price-cell').html('<span class="text-muted">-</span>');
        }

        updateSubmitButton();
    });

    // Toggle all checkboxes
    $('#toggleAllRecipes').on('click', function() {
        const $btn = $(this);
        const $checkboxes = $('.recipe-select-checkbox');
        const allChecked = $checkboxes.filter(':checked').length === $checkboxes.length;

        $checkboxes.prop('checked', !allChecked);

        if (!allChecked) {
            $btn.html('<i class="bi bi-square me-1"></i> {{ _("Deselect All") }}');
            selectedRecipes.clear();
            $checkboxes.each(function() {
                const idx = parseInt($(this).data('recipe-idx'));
                selectedRecipes.add(idx);
                // Add 'required' to unmapped materials in selected recipes
                $(`.material-mapping-select[data-recipe-idx="${idx}"]`).each(function() {
                    if (!$(this).val()) {
                        $(this).prop('required', true);
                    }
                });
            });
        } else {
            $btn.html('<i class="bi bi-check-square me-1"></i> {{ _("Select All") }}');
            selectedRecipes.clear();
            // Remove 'required' from all materials
            $('.material-mapping-select').prop('required', false);
        }

        updateSelectedCount();
        updateSubmitButton();
    });

    // Handle individual checkbox changes
    $('.recipe-select-checkbox').on('change', function() {
        const idx = parseInt($(this).data('recipe-idx'));
        if ($(this).is(':checked')) {
            selectedRecipes.add(idx);
            // Add 'required' to unmapped materials in this recipe
            $(`.material-mapping-select[data-recipe-idx="${idx}"]`).each(function() {
                if (!$(this).val()) {
                    $(this).prop('required', true);
                }
            });
        } else {
            selectedRecipes.delete(idx);
            // Remove 'required' from materials in this recipe
            $(`.material-mapping-select[data-recipe-idx="${idx}"]`).prop('required', false);
        }
        updateSelectedCount();
        updateSubmitButton();
    });

    function updateSelectedCount() {
        $('#selectedCount').text(`${selectedRecipes.size} {{ _("recipes selected") }}`);
    }

    // Assign the function to the global variable so it can be called from recipe_import.js
    updateSubmitButton = function() {
        const $btn = $('#confirmImportBtn');
        const $alert = $('#mappingInfoAlert');
        const $alertText = $('#mappingInfoText');

        // No recipes selected
        if (selectedRecipes.size === 0) {
            $btn.prop('disabled', true);
            $btn.removeClass('btn-success').addClass('btn-secondary');
            $btn.html('<i class="bi bi-info-circle me-2"></i> {{ _("Select recipes to import") }}');
            $alert.hide();
            return;
        }

        // Count unmapped materials in SELECTED recipes only
        let totalUnmappedInSelected = 0;
        for (const recipeIdx of selectedRecipes) {
            if (recipeMaterialStatus.has(recipeIdx)) {
                totalUnmappedInSelected += recipeMaterialStatus.get(recipeIdx).size;
            }
        }

        // Check if all selected recipes have all materials mapped
        if (totalUnmappedInSelected === 0) {
            $btn.prop('disabled', false);
            $btn.removeClass('btn-secondary').addClass('btn-success');
            $btn.html(`<i class="bi bi-check-lg me-2"></i> {{ _("Import") }} ${selectedRecipes.size} {{ _("recipes") }}`);
            $alert.hide();
        } else {
            $btn.prop('disabled', true);
            $btn.removeClass('btn-success').addClass('btn-secondary');
            $btn.html(`<i class="bi bi-x-circle me-2"></i> ${totalUnmappedInSelected} {{ _("unmapped materials in selected recipes") }}`);
            $alertText.text('{{ _("Select a match for all missing materials in selected recipes from the dropdowns.") }}');
            $alert.show();
        }
    }
});
</script>

{% endblock %}
