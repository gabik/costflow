{% extends "base.html" %}
{% block title %}סקירת מתכונים לייבוא - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">סקירת מתכונים לייבוא</h1>
        <p class="text-secondary">
            סוג: <span class="badge bg-info">{{ metadata.type }}</span> |
            קטגוריה: <strong>{{ category.name }}</strong> |
            יחידה: <strong>{{ metadata.unit }}</strong> |
            סה"כ מתכונים: <strong>{{ recipes|length }}</strong>
        </p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category_msg, message in messages %}
      <div class="alert alert-{{ 'danger' if category_msg == 'error' else category_msg }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Missing Materials Warning -->
{% if has_missing_materials %}
<div class="alert alert-danger" role="alert">
    <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>חומרים חסרים במערכת!</h5>
    <p>בחר התאמה לחומרים החסרים מהרשימה הנפתחת, או הוסף את החומרים למערכת:</p>
    <ul class="mb-3">
        {% for material in missing_materials %}
        <li><strong>{{ material.name }}</strong> ({{ material.type }})</li>
        {% endfor %}
    </ul>
    <hr>
    <p class="mb-0">
        <i class="bi bi-lightbulb me-2"></i>
        בחר חומר מהרשימה הנפתחת או הוסף חומרים חדשים למערכת ואז ייבא שוב.
    </p>
</div>
{% endif %}

<!-- Recipes Review -->
<form method="POST" action="{{ url_for('recipe_import.confirm_import') }}" id="recipeImportForm">

<!-- Recipe Selection Controls -->
<div class="mb-3 d-flex justify-content-between align-items-center">
    <button type="button" class="btn btn-sm btn-outline-primary" id="toggleAllRecipes">
        <i class="bi bi-check-square me-1"></i> בחר הכל
    </button>
    <span class="text-muted" id="selectedCount">0 מתכונים נבחרו</span>
</div>

<div class="accordion" id="recipesAccordion">
    {% for recipe in recipes %}
    {% set recipe_idx = loop.index0 %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ loop.index }}">
            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}"
                    aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                    aria-controls="collapse{{ loop.index }}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <input type="checkbox"
                               name="import_recipe{{ recipe_idx }}"
                               value="1"
                               class="form-check-input recipe-select-checkbox"
                               id="recipeCheckbox{{ recipe_idx }}"
                               data-recipe-idx="{{ recipe_idx }}"
                               data-has-missing="{{ recipe.has_missing|lower }}"
                               onclick="event.stopPropagation();">
                        <label for="recipeCheckbox{{ recipe_idx }}" class="fw-bold mb-0" onclick="event.stopPropagation();">{{ recipe.name }}</label>
                    </div>
                    <div class="d-flex gap-2 me-3">
                        {% if recipe.exists %}
                        <span class="badge bg-warning">קיים - יעודכן</span>
                        {% else %}
                        <span class="badge bg-success">חדש</span>
                        {% endif %}
                        {% if recipe.has_missing %}
                        <span class="badge bg-danger">חסרים חומרים</span>
                        {% endif %}
                    </div>
                </div>
            </button>
        </h2>
        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
             aria-labelledby="heading{{ loop.index }}" data-bs-parent="#recipesAccordion">
            <div class="accordion-body">

                <!-- Materials Table -->
                <h6 class="fw-bold mb-3">חומרי גלם:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>שם</th>
                                <th>סוג</th>
                                <th style="min-width: 300px;">סטטוס</th>
                                <th>משקל (ג')</th>
                                <th>מחיר בגיליון</th>
                                <th>מחיר במערכת</th>
                                <th>התאמה</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in recipe.materials %}
                            <tr class="{% if not material.found %}table-danger{% elif material.price_differs %}table-warning{% endif %}">
                                <td><strong>{{ material.name }}</strong></td>
                                <td><small class="text-muted">{{ material.type }}</small></td>
                                <td>
                                    {% if material.found %}
                                        {% if material.matched_via_alternative %}
                                        <span class="badge bg-info" title="נמצא באמצעות שם חלופי">
                                            <i class="bi bi-tag-fill"></i> נמצא (שם חלופי)
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> נמצא</span>
                                        {% endif %}
                                    {% else %}
                                    <!-- Dropdown for mapping missing material -->
                                    <select name="mapping_recipe{{ recipe_idx }}_mat{{ loop.index0 }}"
                                            class="form-select form-select-sm material-mapping-select"
                                            data-material-type="{{ material.type }}"
                                            data-sheet-price="{{ material.sheet_price }}"
                                            data-recipe-idx="{{ recipe_idx }}"
                                            data-material-idx="{{ loop.index0 }}">
                                        <option value="">בחר חומר מהמערכת...</option>

                                        {% if material.type == 'חומר גלם' %}
                                            {% for rm in all_raw_materials %}
                                            <option value="{{ rm.id }}" data-price="{{ rm.cost_per_unit }}">
                                                {{ rm.name }} ({{ "%.2f"|format(rm.cost_per_unit) }} ₪/{{ rm.unit }})
                                            </option>
                                            {% endfor %}
                                        {% elif material.type == 'הכנה' %}
                                            {% for pm in all_premakes %}
                                            <option value="{{ pm.id }}">{{ pm.name }}</option>
                                            {% endfor %}
                                        {% elif material.type == 'מוצר מקדים' %}
                                            {% for pp in all_preproducts %}
                                            <option value="{{ pp.id }}">{{ pp.name }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    {% endif %}
                                </td>
                                <td>
                                    <input type="number"
                                           name="weight_recipe{{ recipe_idx }}_mat{{ loop.index0 }}"
                                           class="form-control form-control-sm weight-input"
                                           value="{{ material.weight }}"
                                           step="0.1"
                                           min="0"
                                           required
                                           style="width: 100px;">
                                </td>
                                <td>{{ "%.2f"|format(material.sheet_price) }} ₪</td>
                                <td class="db-price-cell">
                                    {% if material.db_price %}
                                    {{ "%.2f"|format(material.db_price) }} ₪
                                    {% else %}
                                    <span class="text-muted mapped-price-placeholder">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if material.found %}
                                        {% if material.price_differs %}
                                        <span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> שונה</span>
                                        {% else %}
                                        <span class="badge bg-success"><i class="bi bi-check"></i> זהה</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Loss Row -->
                            {% if recipe.loss %}
                            <tr class="table-warning">
                                <td><strong>{{ recipe.loss.name }}</strong></td>
                                <td><small class="text-muted">אבדן</small></td>
                                <td><span class="badge bg-secondary">אבדן</span></td>
                                <td>{{ "%.1f"|format(recipe.loss.weight) }}</td>
                                <td colspan="3" class="text-muted"><em>ללא עלות</em></td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">סיכום משקל ועלות:</h6>
                                <ul class="list-unstyled mb-0">
                                    <li><strong>משקל גולמי:</strong> {{ "%.1f"|format(recipe.total_weight) }} ג'</li>
                                    {% if recipe.loss %}
                                    <li><strong>אבדן:</strong> {{ "%.1f"|format(recipe.loss.weight) }} ג'</li>
                                    <li><strong>משקל נטו:</strong> {{ "%.1f"|format(recipe.net_weight) }} ג'</li>
                                    {% endif %}
                                    <li><strong>עלות כוללת:</strong> {{ "%.2f"|format(recipe.total_cost) }} ₪</li>
                                    <li class="mt-2 text-primary"><strong>עלות ל-100 ג':</strong> {{ "%.2f"|format(recipe.cost_100g) }} ₪</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Diff Display (if exists) -->
                    {% if recipe.exists and recipe.diff %}
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">שינויים (ביחס למתכון הקיים):</h6>
                                <ul class="list-unstyled mb-0">
                                    {% if recipe.diff.added %}
                                    <li class="text-success">
                                        <i class="bi bi-plus-circle"></i> <strong>נוסף:</strong>
                                        {% for mat in recipe.diff.added %}
                                        {{ mat.name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </li>
                                    {% endif %}
                                    {% if recipe.diff.removed %}
                                    <li class="text-danger">
                                        <i class="bi bi-dash-circle"></i> <strong>הוסר:</strong>
                                        {% for mat in recipe.diff.removed %}
                                        {{ mat.name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </li>
                                    {% endif %}
                                    {% if recipe.diff.changed %}
                                    <li class="text-warning">
                                        <i class="bi bi-arrow-repeat"></i> <strong>שונה כמות:</strong>
                                        {% for item in recipe.diff.changed %}
                                        {{ item.material.name }} ({{ "%.1f"|format(item.old_quantity) }} → {{ "%.1f"|format(item.new_quantity) }}){% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </li>
                                    {% endif %}
                                    {% if not recipe.diff.added and not recipe.diff.removed and not recipe.diff.changed %}
                                    <li class="text-muted"><i class="bi bi-check-circle"></i> אין שינויים</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
</div>
</form>

<!-- Action Buttons -->
<div class="mt-4 d-flex justify-content-end gap-2">
    <a href="{{ url_for('recipe_import.upload_recipes') }}" class="btn btn-secondary">
        <i class="bi bi-x-circle me-2"></i> ביטול
    </a>
    <button type="submit" form="recipeImportForm" class="btn btn-success btn-lg" id="confirmImportBtn">
        <i class="bi bi-check-lg me-2"></i> אשר וייבא מתכונים
    </button>
</div>

<div class="alert alert-info mt-3" id="mappingInfoAlert" style="display:none;">
    <i class="bi bi-info-circle me-2"></i>
    <span id="mappingInfoText"></span>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize Select2 on material mapping dropdowns
    $('.material-mapping-select').select2({
        theme: 'bootstrap-5',
        dir: 'rtl',
        placeholder: 'חפש חומר...',
        allowClear: true,
        width: '100%'
    });

    // Track unmapped materials per recipe: Map<recipeIdx, Set<materialIdx>>
    let recipeMaterialStatus = new Map();

    // Initialize material tracking from dropdowns
    $('.material-mapping-select').each(function() {
        const recipeIdx = $(this).data('recipe-idx');
        const materialIdx = $(this).data('material-idx');

        if (!recipeMaterialStatus.has(recipeIdx)) {
            recipeMaterialStatus.set(recipeIdx, new Set());
        }
        // Add to unmapped set (since dropdowns only exist for missing materials)
        recipeMaterialStatus.get(recipeIdx).add(materialIdx);
    });

    // Track selected recipes
    let selectedRecipes = new Set();

    updateSubmitButton();
    updateSelectedCount();

    // Handle material selection change
    $('.material-mapping-select').on('change', function() {
        const $select = $(this);
        const selectedOption = $select.find(':selected');
        const $row = $select.closest('tr');
        const recipeIdx = $select.data('recipe-idx');
        const materialIdx = $select.data('material-idx');

        if (selectedOption.val()) {
            // Material mapped - remove from unmapped set
            if (recipeMaterialStatus.has(recipeIdx)) {
                recipeMaterialStatus.get(recipeIdx).delete(materialIdx);
            }

            // Remove required attribute when mapped
            $select.prop('required', false);

            // Show mapped material price
            const dbPrice = selectedOption.data('price');
            if (dbPrice !== undefined) {
                const sheetPrice = parseFloat($select.data('sheet-price'));
                const priceDiff = Math.abs(dbPrice - sheetPrice) > 0.01;

                // Update price cell
                const priceHtml = dbPrice.toFixed(2) + ' ₪';
                const priceClass = priceDiff ? 'text-warning' : 'text-success';
                $row.find('.db-price-cell').html(
                    `<span class="${priceClass}">${priceHtml}</span>`
                );

                // Update row highlight
                if (priceDiff) {
                    $row.removeClass('table-danger').addClass('table-warning');
                } else {
                    $row.removeClass('table-danger');
                }
            }
        } else {
            // Material unmapped - add to unmapped set
            if (!recipeMaterialStatus.has(recipeIdx)) {
                recipeMaterialStatus.set(recipeIdx, new Set());
            }
            recipeMaterialStatus.get(recipeIdx).add(materialIdx);

            // Add required attribute if recipe is selected
            if (selectedRecipes.has(recipeIdx)) {
                $select.prop('required', true);
            }

            $row.addClass('table-danger').removeClass('table-warning');
            $row.find('.db-price-cell').html('<span class="text-muted">-</span>');
        }

        updateSubmitButton();
    });

    // Toggle all checkboxes
    $('#toggleAllRecipes').on('click', function() {
        const $btn = $(this);
        const $checkboxes = $('.recipe-select-checkbox');
        const allChecked = $checkboxes.filter(':checked').length === $checkboxes.length;

        $checkboxes.prop('checked', !allChecked);

        if (!allChecked) {
            $btn.html('<i class="bi bi-square me-1"></i> בטל בחירה');
            selectedRecipes.clear();
            $checkboxes.each(function() {
                const idx = parseInt($(this).data('recipe-idx'));
                selectedRecipes.add(idx);
                // Add 'required' to unmapped materials in selected recipes
                $(`.material-mapping-select[data-recipe-idx="${idx}"]`).each(function() {
                    if (!$(this).val()) {
                        $(this).prop('required', true);
                    }
                });
            });
        } else {
            $btn.html('<i class="bi bi-check-square me-1"></i> בחר הכל');
            selectedRecipes.clear();
            // Remove 'required' from all materials
            $('.material-mapping-select').prop('required', false);
        }

        updateSelectedCount();
        updateSubmitButton();
    });

    // Handle individual checkbox changes
    $('.recipe-select-checkbox').on('change', function() {
        const idx = parseInt($(this).data('recipe-idx'));
        if ($(this).is(':checked')) {
            selectedRecipes.add(idx);
            // Add 'required' to unmapped materials in this recipe
            $(`.material-mapping-select[data-recipe-idx="${idx}"]`).each(function() {
                if (!$(this).val()) {
                    $(this).prop('required', true);
                }
            });
        } else {
            selectedRecipes.delete(idx);
            // Remove 'required' from materials in this recipe
            $(`.material-mapping-select[data-recipe-idx="${idx}"]`).prop('required', false);
        }
        updateSelectedCount();
        updateSubmitButton();
    });

    function updateSelectedCount() {
        $('#selectedCount').text(`${selectedRecipes.size} מתכונים נבחרו`);
    }

    function updateSubmitButton() {
        const $btn = $('#confirmImportBtn');
        const $alert = $('#mappingInfoAlert');
        const $alertText = $('#mappingInfoText');

        // No recipes selected
        if (selectedRecipes.size === 0) {
            $btn.prop('disabled', true);
            $btn.removeClass('btn-success').addClass('btn-secondary');
            $btn.html('<i class="bi bi-info-circle me-2"></i> בחר מתכונים לייבוא');
            $alert.hide();
            return;
        }

        // Count unmapped materials in SELECTED recipes only
        let totalUnmappedInSelected = 0;
        for (const recipeIdx of selectedRecipes) {
            if (recipeMaterialStatus.has(recipeIdx)) {
                totalUnmappedInSelected += recipeMaterialStatus.get(recipeIdx).size;
            }
        }

        // Check if all selected recipes have all materials mapped
        if (totalUnmappedInSelected === 0) {
            $btn.prop('disabled', false);
            $btn.removeClass('btn-secondary').addClass('btn-success');
            $btn.html(`<i class="bi bi-check-lg me-2"></i> ייבא ${selectedRecipes.size} מתכונים`);
            $alert.hide();
        } else {
            $btn.prop('disabled', true);
            $btn.removeClass('btn-success').addClass('btn-secondary');
            $btn.html(`<i class="bi bi-x-circle me-2"></i> ${totalUnmappedInSelected} חומרים לא מופו במתכונים הנבחרים`);
            $alertText.text('בחר התאמה לכל החומרים החסרים במתכונים הנבחרים מהרשימות הנפתחות.');
            $alert.show();
        }
    }
});
</script>

{% endblock %}
