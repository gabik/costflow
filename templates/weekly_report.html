{% extends "base.html" %}
{% block title %}דו"ח שבועי - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">דו"ח שבועי</h1>
        <p class="text-secondary">
            סיכום ביצועים לשבוע {{ week_start.strftime('%d/%m/%Y') }} - {{ week_end.strftime('%d/%m/%Y') }}
        </p>
    </div>
</div>

<!-- Week Selector -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="GET" action="{{ url_for('main.weekly_report') }}" class="d-flex gap-2">
            <input type="date" name="week_start" value="{{ week_start }}" class="form-control">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search me-2"></i>הצג דו"ח
            </button>
        </form>
    </div>
    <div class="col-md-6 text-end">
        <button onclick="window.print()" class="btn btn-outline-secondary">
            <i class="bi bi-printer me-2"></i>הדפסה
        </button>
    </div>
</div>

{% if no_data %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    לא נמצאו נתונים עבור השבוע הנבחר
</div>
{% else %}

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">הכנסות</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(total_revenue) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-title">עלות לייבור</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(labor_costs) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">רווח נטו</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(net_profit) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">שיעור רווח</h6>
                <h3 class="mb-0">{{ "%.1f"|format((net_profit / total_revenue * 100) if total_revenue > 0 else 0) }}%</h3>
            </div>
        </div>
    </div>
</div>

<!-- Sales by Category -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>מכירות לפי קטגוריה</h5>
    </div>
    <div class="card-body">
        {% if category_summaries %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>קטגוריה</th>
                        <th>מספר מוצרים</th>
                        <th>כמות נמכרה</th>
                        <th>כמות פחת</th>
                        <th>הכנסות</th>
                        <th>% מההכנסות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cat_name, cat_data in category_summaries.items() %}
                    <tr>
                        <td class="fw-medium">{{ cat_name }}</td>
                        <td>{{ cat_data.products|length }}</td>
                        <td>{{ cat_data.quantity_sold }}</td>
                        <td>{{ cat_data.quantity_waste }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(cat_data.revenue) }}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar"
                                     style="width: {{ (cat_data.revenue / total_revenue * 100) if total_revenue > 0 else 0 }}%">
                                    {{ "%.1f"|format((cat_data.revenue / total_revenue * 100) if total_revenue > 0 else 0) }}%
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>סה"כ</th>
                        <th>-</th>
                        <th>{{ category_summaries.values()|sum(attribute='quantity_sold') }}</th>
                        <th>{{ category_summaries.values()|sum(attribute='quantity_waste') }}</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(total_revenue) }}</th>
                        <th>100%</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <p class="text-muted">אין נתוני מכירות לפי קטגוריה</p>
        {% endif %}
    </div>
</div>

<!-- Product Sales Details -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>פירוט מכירות מוצרים</h5>
    </div>
    <div class="card-body">
        {% if sales_data %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>מוצר</th>
                        <th>קטגוריה</th>
                        <th>מחיר יחידה</th>
                        <th>כמות נמכרה</th>
                        <th>כמות פחת</th>
                        <th>הכנסות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales_data %}
                    <tr>
                        <td class="fw-medium">{{ sale.name }}</td>
                        <td>{{ sale.category_name or 'ללא קטגוריה' }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(sale.selling_price_per_unit) }}</td>
                        <td>{{ sale.quantity_sold }}</td>
                        <td>{{ sale.quantity_waste }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(sale.revenue) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">אין נתוני מכירות למוצרים</p>
        {% endif %}
    </div>
</div>

<!-- Labor Breakdown -->
{% if labor_entries %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>פירוט עלויות לייבור</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>עובד</th>
                        <th>שעות</th>
                        <th>עלות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in labor_entries %}
                    <tr>
                        <td class="fw-medium">{{ entry.employee.name if entry.employee else 'עובד לא ידוע' }}</td>
                        <td>{{ entry.hours }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(entry.cost) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>סה"כ</th>
                        <th>{{ labor_entries|sum(attribute='hours') }}</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(labor_costs) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Key Insights -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>תובנות מרכזיות</h5>
    </div>
    <div class="card-body">
        <ul class="list-unstyled mb-0">
            {% if category_summaries %}
                {% set best_category = category_summaries.items()|sort(attribute='1.revenue', reverse=True)|first %}
                {% if best_category %}
                <li class="mb-2">
                    <i class="bi bi-star-fill text-warning me-2"></i>
                    הקטגוריה המובילה: <strong>{{ best_category[0] }}</strong> עם הכנסות של {{ currency_symbol }}{{ "%.2f"|format(best_category[1].revenue) }}
                </li>
                {% endif %}
            {% endif %}

            {% if sales_data %}
                {% set best_product = sales_data|sort(attribute='revenue', reverse=True)|first %}
                {% if best_product %}
                <li class="mb-2">
                    <i class="bi bi-trophy-fill text-success me-2"></i>
                    המוצר הנמכר ביותר: <strong>{{ best_product.name }}</strong> עם הכנסות של {{ currency_symbol }}{{ "%.2f"|format(best_product.revenue) }}
                </li>
                {% endif %}
            {% endif %}

            <li class="mb-2">
                <i class="bi bi-graph-up text-info me-2"></i>
                שיעור הרווח השבועי: <strong>{{ "%.1f"|format((net_profit / total_revenue * 100) if total_revenue > 0 else 0) }}%</strong>
            </li>

            {% if category_summaries %}
                {% set total_waste = category_summaries.values()|sum(attribute='quantity_waste') %}
                {% set total_sold = category_summaries.values()|sum(attribute='quantity_sold') %}
                {% if total_sold > 0 %}
                <li class="mb-2">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    שיעור הפחת הכולל: <strong>{{ "%.1f"|format((total_waste / (total_sold + total_waste) * 100) if (total_sold + total_waste) > 0 else 0) }}%</strong>
                </li>
                {% endif %}
            {% endif %}
        </ul>
    </div>
</div>

{% endif %}

<style>
@media print {
    .navbar, .btn, form {
        display: none !important;
    }
    .card {
        break-inside: avoid;
    }
}
</style>

{% endblock %}