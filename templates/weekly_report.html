{% extends "base.html" %}
{% block title %}דו"ח שבועי - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">דו"ח שבועי</h1>
        <p class="text-secondary">
            סיכום ביצועים לשבוע {{ week_start.strftime('%d/%m/%Y') }} - {{ week_end.strftime('%d/%m/%Y') }}
        </p>
    </div>
</div>

<!-- Week Selector -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="GET" action="{{ url_for('main.weekly_report') }}" class="d-flex gap-2">
            <input type="date" name="week_start" value="{{ week_start }}" class="form-control">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search me-2"></i>הצג דו"ח
            </button>
        </form>
    </div>
    <div class="col-md-6 text-end">
        <button onclick="window.print()" class="btn btn-outline-secondary">
            <i class="bi bi-printer me-2"></i>הדפסה
        </button>
    </div>
</div>

{% if no_data %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    לא נמצאו נתונים עבור השבוע הנבחר
</div>
{% else %}

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">הכנסות</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(total_revenue) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6 class="card-title">עלות חומרים</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(total_material_costs) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-title">עלות לייבור</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(labor_costs) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">רווח נטו</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(net_profit) }}</h3>
                <small>{{ "%.1f"|format((net_profit / total_revenue * 100) if total_revenue > 0 else 0) }}%</small>
            </div>
        </div>
    </div>
</div>

<!-- Food Cost Analysis -->
<div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>ניתוח עלות מזון (Food Cost)</h5>
        <a href="{{ url_for('main.monthly_report') }}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-bar-chart-line me-1"></i>מגמות חודשיות
        </a>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="text-center">
                    <h6 class="text-muted">סך עלות מזון</h6>
                    <h3 class="text-primary">{{ currency_symbol }}{{ "%.2f"|format(total_food_cost) }}</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h6 class="text-muted">עלות ממוצעת למתכון</h6>
                    <h3 class="text-info">{{ currency_symbol }}{{ "%.2f"|format(avg_food_cost_per_recipe) }}</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h6 class="text-muted">סך מתכונים שיוצרו</h6>
                    <h3 class="text-success">{{ total_recipes_produced }}</h3>
                </div>
            </div>
        </div>

        {% if production_details %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>מוצר</th>
                        <th>פעמי ייצור</th>
                        <th>סך מתכונים</th>
                        <th>יח' למתכון</th>
                        <th>עלות למתכון</th>
                        <th>סך עלות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prod in production_details %}
                    <tr>
                        <td>{{ prod.product_name }}</td>
                        <td>
                            <span class="badge bg-light text-dark border">{{ prod.production_count }}</span>
                        </td>
                        <td class="fw-bold">{{ prod.recipes_produced }}</td>
                        <td>{{ prod.units_per_recipe }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(prod.cost_per_recipe) }}</td>
                        <td class="fw-bold text-primary">{{ currency_symbol }}{{ "%.2f"|format(prod.total_cost) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if total_revenue > 0 and total_food_cost > 0 %}
        <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>אחוז עלות מזון:</strong>
            {{ "%.1f"|format((total_food_cost / total_revenue * 100)) }}%
            מההכנסות
            <small class="text-muted">(יעד מומלץ: 25-35%)</small>
        </div>
        {% endif %}
    </div>
</div>

<!-- Sales by Category -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>מכירות לפי קטגוריה</h5>
    </div>
    <div class="card-body">
        {% if category_summaries %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>קטגוריה</th>
                        <th>מספר מוצרים</th>
                        <th>כמות נמכרה</th>
                        <th>כמות פחת</th>
                        <th>הכנסות</th>
                        <th>עלות חומרים</th>
                        <th>רווח גולמי</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cat_name, cat_data in category_summaries.items() %}
                    <tr>
                        <td class="fw-medium">{{ cat_name }}</td>
                        <td>{{ cat_data.products|length }}</td>
                        <td>{{ cat_data.quantity_sold }}</td>
                        <td>{{ cat_data.quantity_waste }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(cat_data.revenue) }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(cat_data.material_cost) }}</td>
                        <td class="{% if cat_data.revenue - cat_data.material_cost > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ currency_symbol }}{{ "%.2f"|format(cat_data.revenue - cat_data.material_cost) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>סה"כ</th>
                        <th>-</th>
                        <th>{{ category_summaries.values()|sum(attribute='quantity_sold') }}</th>
                        <th>{{ category_summaries.values()|sum(attribute='quantity_waste') }}</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(total_revenue) }}</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(total_material_costs) }}</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(total_revenue - total_material_costs) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <p class="text-muted">אין נתוני מכירות לפי קטגוריה</p>
        {% endif %}
    </div>
</div>

<!-- Product Sales Details -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>פירוט מכירות מוצרים</h5>
    </div>
    <div class="card-body">
        {% if sales_data %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>מוצר</th>
                        <th>קטגוריה</th>
                        <th>מחיר יחידה</th>
                        <th>כמות נמכרה</th>
                        <th>כמות פחת</th>
                        <th>הכנסות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales_data %}
                    <tr>
                        <td class="fw-medium">{{ sale.name }}</td>
                        <td>{{ sale.category_name or 'ללא קטגוריה' }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(sale.selling_price_per_unit) }}</td>
                        <td>{{ sale.quantity_sold }}</td>
                        <td>{{ sale.quantity_waste }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(sale.revenue) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">אין נתוני מכירות למוצרים</p>
        {% endif %}
    </div>
</div>

<!-- Labor Breakdown -->
{% if labor_entries %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>פירוט עלויות לייבור</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>עובד</th>
                        <th>פעמי רישום</th>
                        <th>סך שעות</th>
                        <th>סך עלות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in labor_entries %}
                    <tr>
                        <td class="fw-medium">{{ entry.employee_name }}</td>
                        <td>
                            <span class="badge bg-light text-dark border">{{ entry.entry_count }}</span>
                        </td>
                        <td class="fw-bold">{{ entry.hours }}</td>
                        <td class="fw-bold text-primary">{{ currency_symbol }}{{ "%.2f"|format(entry.cost) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>סה"כ</th>
                        <th></th>
                        <th class="fw-bold">{{ labor_entries|sum(attribute='hours') }}</th>
                        <th class="fw-bold text-primary">{{ currency_symbol }}{{ "%.2f"|format(labor_costs) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Stock Discrepancies -->
{% if stock_audits %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>הפרשי מלאי שנמצאו השבוע</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <h6>סיכום הפרשים</h6>
                <ul class="list-unstyled">
                    <li><strong>מספר ספירות:</strong> {{ stock_audit_count }}</li>
                    <li class="{% if total_stock_variance_cost < 0 %}text-danger{% else %}text-success{% endif %}">
                        <strong>סך ערך כספי:</strong> {{ currency_symbol }}{{ "%.2f"|format(total_stock_variance_cost) }}
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>הפרשים לפי קטגוריה</h6>
                {% if audit_by_category %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>קטגוריה</th>
                            <th>ספירות</th>
                            <th>ערך כספי</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cat_name, cat_data in audit_by_category.items() %}
                        <tr>
                            <td>{{ cat_name }}</td>
                            <td>{{ cat_data.count }}</td>
                            <td class="{% if cat_data.variance_cost < 0 %}text-danger{% endif %}">
                                {{ currency_symbol }}{{ "%.2f"|format(cat_data.variance_cost) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
        </div>

        {% if total_stock_variance_cost != 0 %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>רווח מתואם (כולל הפרשי מלאי):</strong>
            {{ currency_symbol }}{{ "%.2f"|format(adjusted_profit) }}
            <small class="text-muted">(במקום {{ currency_symbol }}{{ "%.2f"|format(net_profit) }})</small>
        </div>
        {% endif %}

        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>תאריך</th>
                        <th>חומר גלם</th>
                        <th>הפרש</th>
                        <th>ערך כספי</th>
                        <th>סופר</th>
                    </tr>
                </thead>
                <tbody>
                    {% for audit in stock_audits[:5] %}
                    <tr>
                        <td>{{ audit.audit_date.strftime('%d/%m %H:%M') }}</td>
                        <td>{{ audit.raw_material.name if audit.raw_material else 'לא ידוע' }}</td>
                        <td class="{% if audit.variance < 0 %}text-danger{% endif %}">
                            {{ "%.1f"|format(audit.variance) }}
                        </td>
                        <td class="{% if audit.variance_cost < 0 %}text-danger{% endif %}">
                            {{ currency_symbol }}{{ "%.2f"|format(audit.variance_cost) }}
                        </td>
                        <td>{{ audit.auditor_name or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if stock_audits|length > 5 %}
            <p class="text-muted small">מוצגות 5 הספירות האחרונות מתוך {{ stock_audits|length }}</p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Key Insights -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>תובנות מרכזיות</h5>
    </div>
    <div class="card-body">
        <ul class="list-unstyled mb-0">
            {% if category_summaries %}
                {% set best_category = category_summaries.items()|sort(attribute='1.revenue', reverse=True)|first %}
                {% if best_category %}
                <li class="mb-2">
                    <i class="bi bi-star-fill text-warning me-2"></i>
                    הקטגוריה המובילה: <strong>{{ best_category[0] }}</strong> עם הכנסות של {{ currency_symbol }}{{ "%.2f"|format(best_category[1].revenue) }}
                </li>
                {% endif %}
            {% endif %}

            {% if sales_data %}
                {% set best_product = sales_data|sort(attribute='revenue', reverse=True)|first %}
                {% if best_product %}
                <li class="mb-2">
                    <i class="bi bi-trophy-fill text-success me-2"></i>
                    המוצר הנמכר ביותר: <strong>{{ best_product.name }}</strong> עם הכנסות של {{ currency_symbol }}{{ "%.2f"|format(best_product.revenue) }}
                </li>
                {% endif %}
            {% endif %}

            <li class="mb-2">
                <i class="bi bi-graph-up text-info me-2"></i>
                שיעור הרווח השבועי: <strong>{{ "%.1f"|format((net_profit / total_revenue * 100) if total_revenue > 0 else 0) }}%</strong>
            </li>

            {% if category_summaries %}
                {% set total_waste = category_summaries.values()|sum(attribute='quantity_waste') %}
                {% set total_sold = category_summaries.values()|sum(attribute='quantity_sold') %}
                {% if total_sold > 0 %}
                <li class="mb-2">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    שיעור הפחת הכולל: <strong>{{ "%.1f"|format((total_waste / (total_sold + total_waste) * 100) if (total_sold + total_waste) > 0 else 0) }}%</strong>
                </li>
                {% endif %}
            {% endif %}
        </ul>
    </div>
</div>

{% endif %}

<style>
@media print {
    .navbar, .btn, form {
        display: none !important;
    }
    .card {
        break-inside: avoid;
    }
}
</style>

{% endblock %}