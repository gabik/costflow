{% extends "base.html" %}
{% block title %}{{ _('Edit') if material else _('Add') }} {{ _('Raw Material') }} - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">{{ 'עריכת חומר גלם' if material else 'הוספת חומר גלם חדש' }}</h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form method="POST" onsubmit="return checkRemovedSuppliers()">
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">שם חומר הגלם</label>
                        <input type="text" id="name" name="name" class="form-control" value="{{ material.name if material else '' }}" placeholder="לדוגמה: קמח לבן" required>
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label">קטגוריה</label>
                        <div class="input-group">
                            <select id="category" name="category" class="form-select" required>
                                <option value="" disabled selected>בחר קטגוריה...</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if material and material.category_id == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" data-category-type="raw_material">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Unit -->
                    <div class="mb-3">
                        <label for="unit" class="form-label">יחידת מידה</label>
                        <select class="form-select" id="unit" name="unit" required>
                            {% for unit in units %}
                            <option value="{{ unit }}" {% if (material and material.unit == unit) or (not material and unit == 'kg') %}selected{% endif %}>{{ unit }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Unlimited Material Checkbox -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input type="checkbox" id="is_unlimited" name="is_unlimited"
                                   class="form-check-input" onchange="toggleUnlimitedMode()"
                                   {% if material and material.is_unlimited %}checked{% endif %}>
                            <label class="form-check-label" for="is_unlimited">
                                <strong>חומר בלתי מוגבל</strong> (מלאי אינסופי, ללא עלות)
                            </label>
                            <div class="form-text">סמן עבור חומרים כמו מים, שאינם דורשים מעקב מלאי או עלות.</div>
                        </div>
                    </div>

                    <!-- Multiple Suppliers Section -->
                    <div class="mb-4" id="suppliersSection">
                        <h5>ספקים ומחירים</h5>

                        <!-- Column headers -->
                        <div class="row g-2 mb-2 fw-bold text-muted small">
                            <div class="col-md-3">ספק</div>
                            <div class="col-md-2">מק"ט (SKU)</div>
                            <div class="col-md-2">מחיר ליחידה</div>
                            {% if material %}
                            <div class="col-md-2">מלאי נוכחי</div>
                            {% endif %}
                            <div class="col-md-2 text-center">ספק ראשי</div>
                            <div class="col-md-1"></div>
                        </div>

                        <div id="suppliersContainer" class="mb-2">
                            <!-- Existing suppliers will be loaded here -->
                        </div>

                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSupplierRow()">
                            <i class="bi bi-plus-lg"></i> הוסף ספק
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1 mt-2"
                                data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                            <i class="bi bi-building-add"></i> ספק חדש
                        </button>
                    </div>

                    <!-- Stock (Only for new items) -->
                    {% if not material %}
                    <div class="mb-4" id="initialStockSection">
                        <label for="stock" class="form-label">מלאי התחלתי</label>
                        <input type="number" id="stock" name="stock" class="form-control" step="0.01" value="0">
                        <div class="form-text">ניתן לעדכן מלאי גם לאחר מכן דרך מסך ניהול המלאי.</div>
                    </div>
                    {% endif %}

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {{ 'שמור שינויים' if material else 'הוסף חומר גלם' }}
                        </button>
                        <a href="{{ url_for('raw_materials.raw_materials') }}" class="btn btn-link text-decoration-none text-secondary">ביטול וחזרה</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('categories.add_category_from_modal') }}">
                <input type="hidden" name="type" id="categoryTypeInput" value="raw_material">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">הוספת קטגוריה חדשה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new_category_name" class="form-label">שם הקטגוריה</label>
                        <input type="text" id="new_category_name" name="name" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף קטגוריה</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Add Supplier Modal -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('suppliers.quick_add_supplier') }}">
                <div class="modal-header">
                    <h5 class="modal-title">הוספת ספק חדש</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="supplier_name" class="form-label">שם הספק *</label>
                        <input type="text" id="supplier_name" name="name"
                               class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="contact_person" class="form-label">איש קשר</label>
                        <input type="text" id="contact_person" name="contact_person"
                               class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">טלפון</label>
                        <input type="tel" id="phone" name="phone" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף ספק</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Stock Transfer Modal -->
<div class="modal fade" id="stockTransferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">טיפול במלאי קיים</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="stockTransferMessage"></p>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="stock_handling_choice"
                               id="transferStock" value="transfer" checked>
                        <label class="form-check-label" for="transferStock">
                            העברת המלאי לספק אחר
                        </label>
                    </div>

                    <div class="mt-2 ms-4" id="transferSupplierSelect" style="display: block;">
                        <select id="transfer_to_supplier_select" class="form-select">
                            <!-- Will be populated with remaining suppliers -->
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="stock_handling_choice"
                               id="wasteStock" value="waste">
                        <label class="form-check-label" for="wasteStock">
                            סימון המלאי כפחת
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="stock_handling_choice"
                               id="keepStock" value="keep">
                        <label class="form-check-label" for="keepStock">
                            השאר את המלאי כמו שהוא
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmStockHandling()">אישור</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden fields for stock handling -->
<input type="hidden" id="stock_handling" name="stock_handling" value="keep">
<input type="hidden" id="transfer_to_supplier" name="transfer_to_supplier" value="">

<!-- Template for supplier row -->
<template id="supplierRowTemplate">
    <div class="supplier-row border rounded p-2 mb-2">
        <div class="row g-2 align-items-center">
            <div class="col-md-3">
                <select class="form-select supplier-select" name="supplier_ids[]" required>
                    <option value="">בחר ספק...</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control supplier-sku" name="supplier_skus[]"
                       placeholder="מק''ט אופציונלי">
            </div>
            <div class="col-md-2">
                <div class="input-group">
                    <span class="input-group-text">₪</span>
                    <input type="number" class="form-control supplier-cost" name="supplier_costs[]"
                           placeholder="0.00" step="0.01" required>
                </div>
            </div>
            <div class="col-md-2 text-center">
                <input type="radio" class="form-check-input primary-radio"
                       name="primary_supplier" style="scale: 1.2;">
            </div>
            <div class="col-md-1 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSupplierRow(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    let supplierRowCounter = 0;
    let originalSuppliers = {};
    let removedSuppliersWithStock = [];

    // Store original suppliers with stock on page load
    {% if material and material.supplier_links %}
        {% for link in material.supplier_links %}
            originalSuppliers[{{ link.supplier_id }}] = {
                name: "{{ link.supplier.name }}",
                stock: {{ link.current_stock if link.current_stock is defined else 0 }}
            };
        {% endfor %}
    {% endif %}

    function addSupplierRow(supplierId = '', sku = '', cost = '', isPrimary = false, currentStock = null, isExisting = false) {
        const template = document.getElementById('supplierRowTemplate');
        const container = document.getElementById('suppliersContainer');
        const clone = template.content.cloneNode(true);

        // Set unique value for radio button
        const radio = clone.querySelector('input[type="radio"]');
        supplierRowCounter++;
        radio.value = supplierRowCounter;

        // Add event listener for visual feedback
        radio.addEventListener('change', function() {
            updatePrimarySupplier(this);
        });

        // Pre-fill values if provided
        if (supplierId) {
            clone.querySelector('.supplier-select').value = supplierId;
        }
        if (sku) {
            clone.querySelector('.supplier-sku').value = sku;
        }
        if (cost) {
            clone.querySelector('.supplier-cost').value = cost;
        }
        if (isPrimary) {
            radio.checked = true;
        }

        // If this is an existing supplier with stock info, add stock display
        if (isExisting && currentStock !== null) {
            const row = clone.querySelector('.supplier-row');
            const supplierCol = row.querySelector('.col-md-3');

            // Create stock display element
            const stockCol = document.createElement('div');
            stockCol.className = 'col-md-2';
            stockCol.innerHTML = '<span class="badge bg-' + (currentStock > 0 ? 'success' : 'danger') + '">' +
                                currentStock.toFixed(2) + ' {{ material.unit if material else "" }}</span>';

            // Insert stock column after cost column
            const costCol = row.querySelector('.input-group').parentElement;
            costCol.parentNode.insertBefore(stockCol, costCol.nextSibling);
        }

        container.appendChild(clone);

        // Update visual feedback if primary
        if (isPrimary) {
            updatePrimarySupplier(container.lastElementChild.querySelector('input[type="radio"]'));
        }
    }

    function removeSupplierRow(button) {
        const row = button.closest('.supplier-row');
        const wasPrimary = row.querySelector('input[type="radio"]').checked;
        row.remove();

        // If we removed the primary supplier, make the first one primary
        if (wasPrimary) {
            const firstRadio = document.querySelector('.supplier-row input[type="radio"]');
            if (firstRadio) {
                firstRadio.checked = true;
                updatePrimarySupplier(firstRadio);
            }
        }
    }

    function updatePrimarySupplier(radio) {
        // Remove visual feedback from all rows
        document.querySelectorAll('.supplier-row').forEach(row => {
            row.classList.remove('border-primary', 'border-2', 'bg-light');
        });

        // Add visual feedback to selected row
        if (radio && radio.checked) {
            const row = radio.closest('.supplier-row');
            row.classList.add('border-primary', 'border-2', 'bg-light');
        }
    }

    // Check for removed suppliers with stock before form submission
    function checkRemovedSuppliers() {
        // Only check if we're editing an existing material
        {% if not material %}
        return true; // Allow form submission for new materials
        {% endif %}

        const currentSuppliers = new Set();
        const supplierSelects = document.querySelectorAll('.supplier-select');

        // Get all currently selected suppliers
        supplierSelects.forEach(select => {
            if (select.value) {
                currentSuppliers.add(parseInt(select.value));
            }
        });

        // Find removed suppliers with stock
        removedSuppliersWithStock = [];
        for (const [supplierId, data] of Object.entries(originalSuppliers)) {
            const id = parseInt(supplierId);
            if (!currentSuppliers.has(id) && data.stock > 0) {
                removedSuppliersWithStock.push({
                    id: id,
                    name: data.name,
                    stock: data.stock
                });
            }
        }

        if (removedSuppliersWithStock.length > 0) {
            // Show modal for stock handling
            showStockTransferModal();
            return false; // Prevent form submission
        }

        return true; // Allow form submission
    }

    function showStockTransferModal() {
        const modal = new bootstrap.Modal(document.getElementById('stockTransferModal'));

        // Build message
        let message = 'הספקים הבאים עם מלאי קיים הוסרו:<br><ul>';
        removedSuppliersWithStock.forEach(supplier => {
            message += `<li>${supplier.name}: ${supplier.stock} {{ material.unit if material else "" }}</li>`;
        });
        message += '</ul>מה לעשות עם המלאי?';

        document.getElementById('stockTransferMessage').innerHTML = message;

        // Populate transfer supplier dropdown with remaining suppliers
        const transferSelect = document.getElementById('transfer_to_supplier_select');
        transferSelect.innerHTML = '';

        const supplierSelects = document.querySelectorAll('.supplier-select');
        const addedSuppliers = new Set();

        supplierSelects.forEach(select => {
            if (select.value && !addedSuppliers.has(select.value)) {
                const option = document.createElement('option');
                option.value = select.value;
                option.text = select.options[select.selectedIndex].text;
                transferSelect.appendChild(option);
                addedSuppliers.add(select.value);
            }
        });

        // Show/hide transfer supplier select based on radio selection
        document.querySelectorAll('input[name="stock_handling_choice"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('transferSupplierSelect').style.display =
                    this.value === 'transfer' ? 'block' : 'none';
            });
        });

        modal.show();
    }

    function confirmStockHandling() {
        const choice = document.querySelector('input[name="stock_handling_choice"]:checked').value;
        document.getElementById('stock_handling').value = choice;

        if (choice === 'transfer') {
            const transferTo = document.getElementById('transfer_to_supplier_select').value;
            document.getElementById('transfer_to_supplier').value = transferTo;
        }

        // Close modal and submit form
        const modal = bootstrap.Modal.getInstance(document.getElementById('stockTransferModal'));
        modal.hide();

        // Submit the form
        document.querySelector('form').submit();
    }

    function toggleUnlimitedMode() {
        const isUnlimited = document.getElementById('is_unlimited').checked;
        const suppliersSection = document.getElementById('suppliersSection');
        const initialStockSection = document.getElementById('initialStockSection');

        if (isUnlimited) {
            // Hide supplier and stock sections
            suppliersSection.style.display = 'none';
            if (initialStockSection) {
                initialStockSection.style.display = 'none';
            }
        } else {
            // Show supplier and stock sections
            suppliersSection.style.display = 'block';
            if (initialStockSection) {
                initialStockSection.style.display = 'block';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize unlimited mode visibility on page load
        toggleUnlimitedMode();

        // Handle category modal
        const addCategoryModal = document.getElementById('addCategoryModal');
        if (addCategoryModal) {
            addCategoryModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const type = button.getAttribute('data-category-type');
                const modalInput = addCategoryModal.querySelector('#categoryTypeInput');
                if (modalInput && type) {
                    modalInput.value = type;
                }
            });
        }

        // Load existing supplier links for edit mode
        {% if material and material.supplier_links %}
            {% for link in material.supplier_links %}
            addSupplierRow(
                '{{ link.supplier_id }}',
                '{{ link.sku if link.sku else '' }}',
                '{{ link.cost_per_unit }}',
                {{ 'true' if link.is_primary else 'false' }},
                {{ link.current_stock if link.current_stock is defined else 'null' }},
                true  // isExisting = true
            );
            {% endfor %}
        {% else %}
            // Add one empty row for new materials and make it primary by default
            addSupplierRow();
            const firstRadio = document.querySelector('.supplier-row input[type="radio"]');
            if (firstRadio) {
                firstRadio.checked = true;
                updatePrimarySupplier(firstRadio);
            }
        {% endif %}
    });
</script>
{% endblock %}