{% extends "base.html" %}
{% block title %}{{ _('Edit') if material else _('Add') }} {{ _('Raw Material') }} - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">{{ 'עריכת חומר גלם' if material else 'הוספת חומר גלם חדש' }}</h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form method="POST">
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">שם חומר הגלם</label>
                        <input type="text" id="name" name="name" class="form-control" value="{{ material.name if material else '' }}" placeholder="לדוגמה: קמח לבן" required>
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label">קטגוריה</label>
                        <div class="input-group">
                            <select id="category" name="category" class="form-select" required>
                                <option value="" disabled selected>בחר קטגוריה...</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if material and material.category_id == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" data-category-type="raw_material">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Unit -->
                    <div class="mb-3">
                        <label for="unit" class="form-label">יחידת מידה</label>
                        <select class="form-select" id="unit" name="unit" required>
                            {% for unit in units %}
                            <option value="{{ unit }}" {% if (material and material.unit == unit) or (not material and unit == 'kg') %}selected{% endif %}>{{ unit }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Multiple Suppliers Section -->
                    <div class="mb-4">
                        <h5>ספקים ומחירים</h5>

                        <!-- Column headers -->
                        <div class="row g-2 mb-2 fw-bold text-muted small">
                            <div class="col-md-3">ספק</div>
                            <div class="col-md-2">מחיר ליחידה</div>
                            {% if material %}
                            <div class="col-md-2">מלאי נוכחי</div>
                            {% endif %}
                            <div class="col-md-3 text-center">ספק ראשי</div>
                            <div class="col-md-2"></div>
                        </div>

                        <div id="suppliersContainer" class="mb-2">
                            <!-- Existing suppliers will be loaded here -->
                        </div>

                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSupplierRow()">
                            <i class="bi bi-plus-lg"></i> הוסף ספק
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1 mt-2"
                                data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                            <i class="bi bi-building-add"></i> ספק חדש
                        </button>
                    </div>

                    <!-- Stock (Only for new items) -->
                    {% if not material %}
                    <div class="mb-4">
                        <label for="stock" class="form-label">מלאי התחלתי</label>
                        <input type="number" id="stock" name="stock" class="form-control" step="0.01" value="0">
                        <div class="form-text">ניתן לעדכן מלאי גם לאחר מכן דרך מסך ניהול המלאי.</div>
                    </div>
                    {% endif %}

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {{ 'שמור שינויים' if material else 'הוסף חומר גלם' }}
                        </button>
                        <a href="{{ url_for('raw_materials.raw_materials') }}" class="btn btn-link text-decoration-none text-secondary">ביטול וחזרה</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('categories.add_category_from_modal') }}">
                <input type="hidden" name="type" id="categoryTypeInput" value="raw_material">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">הוספת קטגוריה חדשה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new_category_name" class="form-label">שם הקטגוריה</label>
                        <input type="text" id="new_category_name" name="name" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף קטגוריה</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Add Supplier Modal -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('suppliers.quick_add_supplier') }}">
                <div class="modal-header">
                    <h5 class="modal-title">הוספת ספק חדש</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="supplier_name" class="form-label">שם הספק *</label>
                        <input type="text" id="supplier_name" name="name"
                               class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="contact_person" class="form-label">איש קשר</label>
                        <input type="text" id="contact_person" name="contact_person"
                               class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">טלפון</label>
                        <input type="tel" id="phone" name="phone" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף ספק</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template for supplier row -->
<template id="supplierRowTemplate">
    <div class="supplier-row border rounded p-2 mb-2">
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <select class="form-select supplier-select" name="supplier_ids[]" required>
                    <option value="">בחר ספק...</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text">₪</span>
                    <input type="number" class="form-control supplier-cost" name="supplier_costs[]"
                           placeholder="0.00" step="0.01" required>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <input type="radio" class="form-check-input primary-radio"
                       name="primary_supplier" style="scale: 1.2;">
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSupplierRow(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    let supplierRowCounter = 0;

    function addSupplierRow(supplierId = '', cost = '', isPrimary = false, currentStock = null, isExisting = false) {
        const template = document.getElementById('supplierRowTemplate');
        const container = document.getElementById('suppliersContainer');
        const clone = template.content.cloneNode(true);

        // Set unique value for radio button
        const radio = clone.querySelector('input[type="radio"]');
        supplierRowCounter++;
        radio.value = supplierRowCounter;

        // Add event listener for visual feedback
        radio.addEventListener('change', function() {
            updatePrimarySupplier(this);
        });

        // Pre-fill values if provided
        if (supplierId) {
            clone.querySelector('.supplier-select').value = supplierId;
        }
        if (cost) {
            clone.querySelector('.supplier-cost').value = cost;
        }
        if (isPrimary) {
            radio.checked = true;
        }

        // If this is an existing supplier with stock info, add stock display
        if (isExisting && currentStock !== null) {
            const row = clone.querySelector('.supplier-row');
            const supplierCol = row.querySelector('.col-md-4');

            // Create stock display element
            const stockCol = document.createElement('div');
            stockCol.className = 'col-md-2';
            stockCol.innerHTML = '<span class="badge bg-' + (currentStock > 0 ? 'success' : 'danger') + '">' +
                                currentStock.toFixed(2) + ' {{ material.unit if material else "" }}</span>';

            // Adjust column widths for existing items with stock display
            supplierCol.className = 'col-md-3';
            row.querySelector('.col-md-3').className = 'col-md-2'; // Cost column

            // Insert stock column after cost column
            const costCol = row.querySelector('.input-group').parentElement;
            costCol.parentNode.insertBefore(stockCol, costCol.nextSibling);
        }

        container.appendChild(clone);

        // Update visual feedback if primary
        if (isPrimary) {
            updatePrimarySupplier(container.lastElementChild.querySelector('input[type="radio"]'));
        }
    }

    function removeSupplierRow(button) {
        const row = button.closest('.supplier-row');
        const wasPrimary = row.querySelector('input[type="radio"]').checked;
        row.remove();

        // If we removed the primary supplier, make the first one primary
        if (wasPrimary) {
            const firstRadio = document.querySelector('.supplier-row input[type="radio"]');
            if (firstRadio) {
                firstRadio.checked = true;
                updatePrimarySupplier(firstRadio);
            }
        }
    }

    function updatePrimarySupplier(radio) {
        // Remove visual feedback from all rows
        document.querySelectorAll('.supplier-row').forEach(row => {
            row.classList.remove('border-primary', 'border-2', 'bg-light');
        });

        // Add visual feedback to selected row
        if (radio && radio.checked) {
            const row = radio.closest('.supplier-row');
            row.classList.add('border-primary', 'border-2', 'bg-light');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Handle category modal
        const addCategoryModal = document.getElementById('addCategoryModal');
        if (addCategoryModal) {
            addCategoryModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const type = button.getAttribute('data-category-type');
                const modalInput = addCategoryModal.querySelector('#categoryTypeInput');
                if (modalInput && type) {
                    modalInput.value = type;
                }
            });
        }

        // Load existing supplier links for edit mode
        {% if material and material.supplier_links %}
            {% for link in material.supplier_links %}
            addSupplierRow(
                '{{ link.supplier_id }}',
                '{{ link.cost_per_unit }}',
                {{ 'true' if link.is_primary else 'false' }},
                {{ link.current_stock if link.current_stock is defined else 'null' }},
                true  // isExisting = true
            );
            {% endfor %}
        {% else %}
            // Add one empty row for new materials and make it primary by default
            addSupplierRow();
            const firstRadio = document.querySelector('.supplier-row input[type="radio"]');
            if (firstRadio) {
                firstRadio.checked = true;
                updatePrimarySupplier(firstRadio);
            }
        {% endif %}
    });
</script>
{% endblock %}