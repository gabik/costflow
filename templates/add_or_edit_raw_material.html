{% extends "base.html" %}
{% block title %}{{ _('Edit') if material else _('Add') }} {{ _('Raw Material') }} - CostFlow{% endblock %}

{% block head %}
<style>
    /* Ensure proper column widths for supplier rows */
    #suppliersContainer .supplier-row .row > div {
        flex-shrink: 0;
    }
    #suppliersContainer .supplier-select {
        min-width: 120px;
    }
    #suppliersContainer .supplier-sku {
        min-width: 100px;
    }
    #suppliersContainer .supplier-cost {
        min-width: 80px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">{{ _('Edit Raw Material') if material else _('Add New Raw Material') }}</h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-12 col-lg-12">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form method="POST" onsubmit="return checkRemovedSuppliers()">
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">{{ _('Raw Material Name') }}</label>
                        <input type="text" id="name" name="name" class="form-control" value="{{ material.name if material else '' }}" placeholder="{{ _('e.g., White Flour') }}" required>
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label">{{ _('Category') }}</label>
                        <div class="input-group">
                            <select id="category" name="category" class="form-select" required>
                                <option value="" disabled selected>{{ _('Select category...') }}</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if material and material.category_id == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" data-category-type="raw_material">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Unit -->
                    <div class="mb-3">
                        <label for="unit" class="form-label">{{ _('Unit of Measure') }}</label>
                        <select class="form-select" id="unit" name="unit" required>
                            {% for unit in units %}
                            <option value="{{ unit }}" {% if (material and material.unit == unit) or (not material and unit == 'kg') %}selected{% endif %}>{{ unit }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Unlimited Material Checkbox -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input type="checkbox" id="is_unlimited" name="is_unlimited"
                                   class="form-check-input" onchange="toggleUnlimitedMode()"
                                   {% if material and material.is_unlimited %}checked{% endif %}>
                            <label class="form-check-label" for="is_unlimited">
                                <strong>{{ _('Unlimited Material') }}</strong> ({{ _('infinite stock, no cost') }})
                            </label>
                            <div class="form-text">{{ _('Check for materials like water that do not require stock tracking or cost.') }}</div>
                        </div>
                    </div>

                    <!-- Waste Percentage Section -->
                    <div class="mb-4" id="wasteSection" style="{% if material and material.is_unlimited %}display: none;{% endif %}">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="has_waste" name="has_waste"
                                   class="form-check-input" onchange="toggleWasteInput()"
                                   {% if material and material.waste_percentage > 0 %}checked{% endif %}>
                            <label class="form-check-label" for="has_waste">
                                <strong>{{ _('Material has waste') }}</strong>
                            </label>
                        </div>

                        <div id="wastePercentageInput" style="display: {% if material and material.waste_percentage > 0 %}block{% else %}none{% endif %};">
                            <label for="waste_percentage" class="form-label">
                                {{ _('Waste Percentage') }} (%)
                            </label>
                            <div class="input-group">
                                <input type="number" id="waste_percentage" name="waste_percentage"
                                       class="form-control" min="0" max="99" step="0.1"
                                       value="{{ material.waste_percentage if material else 0 }}"
                                       placeholder="{{ _('e.g., 20 for 20%% waste') }}"
                                       onchange="updateEffectiveCostHint()">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">
                                {{ _('Enter the percentage of material lost during processing (0-99%%)') }}
                                <br>
                                <span id="effectiveCostHint" class="text-info"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Alternative Names Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold">{{ _('Alternative Names (optional)') }}</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addAlternativeNameRow()">
                                <i class="bi bi-plus-circle"></i> {{ _('Add Alternative Name') }}
                            </button>
                        </div>

                        <div id="alternativeNamesContainer">
                            {% if material and material.alternative_names %}
                                {% for alt_name in material.alternative_names %}
                                <div class="alternative-name-row input-group mb-2">
                                    <input type="text"
                                           class="form-control"
                                           name="alternative_names[]"
                                           value="{{ alt_name.alternative_name }}"
                                           placeholder="{{ _('Alternative name for material (e.g., White Flour)') }}">
                                    <input type="hidden" name="alternative_name_ids[]" value="{{ alt_name.id }}">
                                    <button type="button" class="btn btn-outline-danger" onclick="removeAlternativeNameRow(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            {{ _('Alternative names help with recipe imports - e.g., "White Flour" for "White Flour T55 12kg"') }}
                        </small>
                    </div>

                    <!-- Multiple Suppliers Section -->
                    <div class="mb-4" id="suppliersSection">
                        <h5>{{ _('Suppliers and Prices') }}</h5>

                        <!-- Column headers -->
                        <div class="row g-2 mb-2 fw-bold text-muted small">
                            {% if material %}
                            <div class="col-2">{{ _('Supplier') }}</div>
                            <div class="col-2">{{ _('SKU') }}</div>
                            <div class="col-2">{{ _('Price per Unit') }}</div>
                            <div class="col-1">{{ _('Units/Pkg') }}</div>
                            <div class="col-2">{{ _('Current Stock') }}</div>
                            <div class="col-2 text-center">{{ _('Primary Supplier') }}</div>
                            <div class="col-1"></div>
                            {% else %}
                            <div class="col-3">{{ _('Supplier') }}</div>
                            <div class="col-2">{{ _('SKU') }}</div>
                            <div class="col-2">{{ _('Price per Unit') }}</div>
                            <div class="col-2">{{ _('Units/Pkg') }}</div>
                            <div class="col-2 text-center">{{ _('Primary Supplier') }}</div>
                            <div class="col-1"></div>
                            {% endif %}
                        </div>

                        <div id="suppliersContainer" class="mb-2">
                            <!-- Existing suppliers will be loaded here -->
                        </div>

                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSupplierRow()">
                            <i class="bi bi-plus-lg"></i> {{ _('Add Supplier') }}
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1 mt-2"
                                data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                            <i class="bi bi-building-add"></i> {{ _('New Supplier') }}
                        </button>
                    </div>

                    <!-- Stock (Only for new items) -->
                    {% if not material %}
                    <div class="mb-4" id="initialStockSection">
                        <label for="stock" class="form-label">{{ _('Initial Stock') }}</label>
                        <input type="number" id="stock" name="stock" class="form-control" step="0.01" value="0">
                        <div class="form-text">{{ _('Stock can be updated later through the inventory management screen.') }}</div>
                    </div>
                    {% endif %}

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {{ _('Save Changes') if material else _('Add Raw Material') }}
                        </button>
                        <a href="{{ url_for('raw_materials.raw_materials') }}" class="btn btn-link text-decoration-none text-secondary">{{ _('Cancel and Return') }}</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('categories.add_category_from_modal') }}">
                <input type="hidden" name="type" id="categoryTypeInput" value="raw_material">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">{{ _('Add New Category') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new_category_name" class="form-label">{{ _('Category Name') }}</label>
                        <input type="text" id="new_category_name" name="name" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Add Category') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Add Supplier Modal -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('suppliers.quick_add_supplier') }}">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Add New Supplier') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="supplier_name" class="form-label">{{ _('Supplier Name') }} *</label>
                        <input type="text" id="supplier_name" name="name"
                               class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="contact_person" class="form-label">{{ _('Contact Person') }}</label>
                        <input type="text" id="contact_person" name="contact_person"
                               class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">{{ _('Phone') }}</label>
                        <input type="tel" id="phone" name="phone" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Add Supplier') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Stock Transfer Modal -->
<div class="modal fade" id="stockTransferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Handle Existing Stock') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="stockTransferMessage"></p>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="stock_handling_choice"
                               id="transferStock" value="transfer" checked>
                        <label class="form-check-label" for="transferStock">
                            {{ _('Transfer stock to another supplier') }}
                        </label>
                    </div>

                    <div class="mt-2 ms-4" id="transferSupplierSelect" style="display: block;">
                        <select id="transfer_to_supplier_select" class="form-select">
                            <!-- Will be populated with remaining suppliers -->
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="stock_handling_choice"
                               id="wasteStock" value="waste">
                        <label class="form-check-label" for="wasteStock">
                            {{ _('Mark stock as waste') }}
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="stock_handling_choice"
                               id="keepStock" value="keep">
                        <label class="form-check-label" for="keepStock">
                            {{ _('Keep stock as is') }}
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmStockHandling()">{{ _('Confirm') }}</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden fields for stock handling -->
<input type="hidden" id="stock_handling" name="stock_handling" value="keep">
<input type="hidden" id="transfer_to_supplier" name="transfer_to_supplier" value="">

<!-- Template for supplier row -->
<template id="supplierRowTemplate">
    <div class="supplier-row border rounded p-2 mb-2">
        <div class="row g-2 align-items-center">
            <div class="col-3 supplier-col">
                <select class="form-select supplier-select" name="supplier_ids[]">
                    <option value="">{{ _('Select supplier...') }}</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-2 sku-col">
                <input type="text" class="form-control supplier-sku" name="supplier_skus[]"
                       placeholder="{{ _('Optional SKU') }}">
            </div>
            <div class="col-2 cost-col">
                <div class="input-group">
                    <span class="input-group-text">₪</span>
                    <input type="number" class="form-control supplier-cost" name="supplier_costs[]"
                           placeholder="0.00" step="0.01">
                </div>
            </div>
            <div class="col-2 upp-col">
                <input type="number" class="form-control supplier-upp" name="supplier_upps[]"
                       placeholder="1" step="0.01" min="0.01" value="1">
            </div>
            <div class="col-2 text-center primary-col">
                <input type="radio" class="form-check-input primary-radio"
                       name="primary_supplier" style="scale: 1.2;">
            </div>
            <div class="col-1 text-end delete-col">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSupplierRow(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>

<template id="alternativeNameRowTemplate">
    <div class="alternative-name-row input-group mb-2">
        <input type="text"
               class="form-control"
               name="alternative_names[]"
               placeholder="{{ _('Alternative name for material (e.g., White Flour)') }}">
        <input type="hidden" name="alternative_name_ids[]" value="">
        <button type="button" class="btn btn-outline-danger" onclick="removeAlternativeNameRow(this)">
            <i class="bi bi-trash"></i>
        </button>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    let supplierRowCounter = 0;
    let originalSuppliers = {};
    let removedSuppliersWithStock = [];

    // Store original suppliers with stock on page load
    {% if material and material.supplier_links %}
        {% for link in material.supplier_links %}
            originalSuppliers[{{ link.supplier_id }}] = {
                name: "{{ link.supplier.name }}",
                stock: {{ link.current_stock if link.current_stock is defined else 0 }}
            };
        {% endfor %}
    {% endif %}

    function addSupplierRow(supplierId = '', sku = '', cost = '', isPrimary = false, currentStock = null, isExisting = false, discountedCost = null, discountPercentage = null, unitsPerPackage = 1) {
        const template = document.getElementById('supplierRowTemplate');
        const container = document.getElementById('suppliersContainer');
        const clone = template.content.cloneNode(true);

        // Set unique value for radio button
        const radio = clone.querySelector('input[type="radio"]');
        supplierRowCounter++;
        radio.value = supplierRowCounter;

        // Add event listener for visual feedback
        radio.addEventListener('change', function() {
            updatePrimarySupplier(this);
        });

        // Pre-fill values if provided
        if (supplierId) {
            clone.querySelector('.supplier-select').value = supplierId;
        }
        if (sku) {
            clone.querySelector('.supplier-sku').value = sku;
        }
        if (cost) {
            clone.querySelector('.supplier-cost').value = cost;
        }
        if (unitsPerPackage) {
            clone.querySelector('.supplier-upp').value = unitsPerPackage;
        }
        if (isPrimary) {
            radio.checked = true;
        }

        const row = clone.querySelector('.supplier-row').querySelector('.row');

        // If this is an existing supplier, we need to adjust the layout to show stock and discount
        if (isExisting) {
            // Adjust column sizes to match header: 2-2-2-1-2-2-1 = 12 columns
            row.querySelector('.supplier-col').className = 'col-2 supplier-col';
            row.querySelector('.sku-col').className = 'col-2 sku-col';
            row.querySelector('.cost-col').className = 'col-2 cost-col';
            row.querySelector('.upp-col').className = 'col-1 upp-col';
            row.querySelector('.primary-col').className = 'col-2 text-center primary-col';
            row.querySelector('.delete-col').className = 'col-1 text-end delete-col';

            // If there's a discount, show it within the cost column
            const costCol = row.querySelector('.cost-col');
            if (discountedCost !== null && discountPercentage > 0 && parseFloat(discountedCost) < parseFloat(cost)) {
                // Modify the cost column to show discount
                const costInput = costCol.querySelector('.supplier-cost');
                costInput.style.textDecoration = 'line-through';
                costInput.parentElement.classList.add('text-muted');

                // Add discount info below the input
                const discountDiv = document.createElement('div');
                discountDiv.className = 'mt-1';
                discountDiv.innerHTML = '<small><strong class="text-success">₪' + parseFloat(discountedCost).toFixed(2) + '</strong>' +
                                       ' <span class="badge bg-success ms-1">-' + discountPercentage.toFixed(1) + '%</span></small>';
                costCol.appendChild(discountDiv);
            }

            // Add stock info as a separate small column
            if (currentStock !== null) {
                const stockCol = document.createElement('div');
                stockCol.className = 'col-2';
                stockCol.innerHTML = '<small class="text-muted d-block">{{ _("Stock") }}</small>' +
                                    '<span class="badge bg-' + (currentStock > 0 ? 'success' : 'danger') + '">' +
                                    currentStock.toFixed(2) + ' {{ material.unit if material else "" }}</span>';

                // Insert stock column before primary column
                const primaryCol = row.querySelector('.primary-col');
                row.insertBefore(stockCol, primaryCol);
            }
        }

        container.appendChild(clone);

        // Update visual feedback if primary
        if (isPrimary) {
            updatePrimarySupplier(container.lastElementChild.querySelector('input[type="radio"]'));
        }
    }

    function removeSupplierRow(button) {
        const row = button.closest('.supplier-row');
        const wasPrimary = row.querySelector('input[type="radio"]').checked;
        row.remove();

        // If we removed the primary supplier, make the first one primary
        if (wasPrimary) {
            const firstRadio = document.querySelector('.supplier-row input[type="radio"]');
            if (firstRadio) {
                firstRadio.checked = true;
                updatePrimarySupplier(firstRadio);
            }
        }
    }

    function updatePrimarySupplier(radio) {
        // Remove visual feedback from all rows
        document.querySelectorAll('.supplier-row').forEach(row => {
            row.classList.remove('border-primary', 'border-2', 'bg-light');
        });

        // Add visual feedback to selected row
        if (radio && radio.checked) {
            const row = radio.closest('.supplier-row');
            row.classList.add('border-primary', 'border-2', 'bg-light');
        }
    }

    // Alternative Names Functions
    function addAlternativeNameRow() {
        const template = document.getElementById('alternativeNameRowTemplate');
        const clone = template.content.cloneNode(true);
        document.getElementById('alternativeNamesContainer').appendChild(clone);
    }

    function removeAlternativeNameRow(button) {
        const row = button.closest('.alternative-name-row');
        const input = row.querySelector('input[name="alternative_names[]"]');

        // If empty or confirmed, remove
        if (!input.value || confirm('{{ _("Delete this alternative name?") }}')) {
            row.remove();
        }
    }

    // Check for removed suppliers with stock before form submission
    function checkRemovedSuppliers() {
        // Remove 'required' from any hidden or invisible fields to prevent validation errors
        const suppliersSection = document.getElementById('suppliersSection');

        // If suppliers section is hidden (unlimited mode), remove required from all supplier fields
        if (suppliersSection && suppliersSection.style.display === 'none') {
            document.querySelectorAll('.supplier-select, .supplier-cost').forEach(field => {
                field.removeAttribute('required');
            });
        }

        // Also check for individual hidden fields
        document.querySelectorAll('input[required], select[required]').forEach(field => {
            const isHidden = field.offsetParent === null ||
                           window.getComputedStyle(field).display === 'none' ||
                           window.getComputedStyle(field).visibility === 'hidden';
            if (isHidden) {
                field.removeAttribute('required');
            }
        });

        // Only check if we're editing an existing material
        {% if not material %}
        return true; // Allow form submission for new materials
        {% endif %}

        const currentSuppliers = new Set();
        const supplierSelects = document.querySelectorAll('.supplier-select');

        // Get all currently selected suppliers
        supplierSelects.forEach(select => {
            if (select.value) {
                currentSuppliers.add(parseInt(select.value));
            }
        });

        // Find removed suppliers with stock
        removedSuppliersWithStock = [];
        for (const [supplierId, data] of Object.entries(originalSuppliers)) {
            const id = parseInt(supplierId);
            if (!currentSuppliers.has(id) && data.stock > 0) {
                removedSuppliersWithStock.push({
                    id: id,
                    name: data.name,
                    stock: data.stock
                });
            }
        }

        if (removedSuppliersWithStock.length > 0) {
            // Show modal for stock handling
            showStockTransferModal();
            return false; // Prevent form submission
        }

        return true; // Allow form submission
    }

    function showStockTransferModal() {
        const modal = new bootstrap.Modal(document.getElementById('stockTransferModal'));

        // Build message
        let message = '{{ _("The following suppliers with existing stock were removed:") }}<br><ul>';
        removedSuppliersWithStock.forEach(supplier => {
            message += `<li>${supplier.name}: ${supplier.stock} {{ material.unit if material else "" }}</li>`;
        });
        message += '</ul>{{ _("What to do with the stock?") }}';

        document.getElementById('stockTransferMessage').innerHTML = message;

        // Populate transfer supplier dropdown with remaining suppliers
        const transferSelect = document.getElementById('transfer_to_supplier_select');
        transferSelect.innerHTML = '';

        const supplierSelects = document.querySelectorAll('.supplier-select');
        const addedSuppliers = new Set();

        supplierSelects.forEach(select => {
            if (select.value && !addedSuppliers.has(select.value)) {
                const option = document.createElement('option');
                option.value = select.value;
                option.text = select.options[select.selectedIndex].text;
                transferSelect.appendChild(option);
                addedSuppliers.add(select.value);
            }
        });

        // Show/hide transfer supplier select based on radio selection
        document.querySelectorAll('input[name="stock_handling_choice"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('transferSupplierSelect').style.display =
                    this.value === 'transfer' ? 'block' : 'none';
            });
        });

        modal.show();
    }

    function confirmStockHandling() {
        const choice = document.querySelector('input[name="stock_handling_choice"]:checked').value;
        document.getElementById('stock_handling').value = choice;

        if (choice === 'transfer') {
            const transferTo = document.getElementById('transfer_to_supplier_select').value;
            document.getElementById('transfer_to_supplier').value = transferTo;
        }

        // Close modal and submit form
        const modal = bootstrap.Modal.getInstance(document.getElementById('stockTransferModal'));
        modal.hide();

        // Submit the form
        document.querySelector('form').submit();
    }

    function toggleUnlimitedMode() {
        const isUnlimited = document.getElementById('is_unlimited').checked;
        const suppliersSection = document.getElementById('suppliersSection');
        const initialStockSection = document.getElementById('initialStockSection');
        const wasteSection = document.getElementById('wasteSection');

        if (isUnlimited) {
            // Hide supplier, stock, and waste sections
            suppliersSection.style.display = 'none';
            if (initialStockSection) {
                initialStockSection.style.display = 'none';
            }
            wasteSection.style.display = 'none';
            // Reset waste values
            document.getElementById('has_waste').checked = false;
            document.getElementById('waste_percentage').value = 0;
            document.getElementById('wastePercentageInput').style.display = 'none';

            // Remove required attribute from supplier fields to prevent validation errors
            document.querySelectorAll('.supplier-select, .supplier-cost').forEach(field => {
                field.removeAttribute('required');
            });
        } else {
            // Show supplier, stock, and waste sections
            suppliersSection.style.display = 'block';
            if (initialStockSection) {
                initialStockSection.style.display = 'block';
            }
            wasteSection.style.display = 'block';

            // Re-add required attribute only to visible supplier fields
            document.querySelectorAll('.supplier-select, .supplier-cost').forEach(field => {
                // Only add required if the field is actually visible
                if (field.offsetParent !== null) {
                    field.setAttribute('required', 'required');
                }
            });
        }
    }

    function toggleWasteInput() {
        const hasWaste = document.getElementById('has_waste').checked;
        const wasteInput = document.getElementById('wastePercentageInput');
        wasteInput.style.display = hasWaste ? 'block' : 'none';
        if (!hasWaste) {
            document.getElementById('waste_percentage').value = 0;
        }
        updateEffectiveCostHint();
    }

    function updateEffectiveCostHint() {
        const wastePercentage = parseFloat(document.getElementById('waste_percentage').value) || 0;
        const hint = document.getElementById('effectiveCostHint');
        if (wastePercentage > 0 && wastePercentage < 100) {
            const multiplier = 1 / (1 - wastePercentage / 100);
            hint.textContent = `{{ _('Effective cost will be') }} ${multiplier.toFixed(2)}x {{ _('the base price') }}`;
        } else {
            hint.textContent = '';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize unlimited mode visibility on page load
        toggleUnlimitedMode();

        // Initialize waste hint on page load
        updateEffectiveCostHint();

        // Handle category modal
        const addCategoryModal = document.getElementById('addCategoryModal');
        if (addCategoryModal) {
            addCategoryModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const type = button.getAttribute('data-category-type');
                const modalInput = addCategoryModal.querySelector('#categoryTypeInput');
                if (modalInput && type) {
                    modalInput.value = type;
                }
            });
        }

        // Load existing supplier links for edit mode
        {% if material and material.supplier_links %}
            {% for link in material.supplier_links %}
            addSupplierRow(
                '{{ link.supplier_id }}',
                '{{ link.sku if link.sku else '' }}',
                '{{ link.cost_per_unit }}',
                {{ 'true' if link.is_primary else 'false' }},
                {{ link.current_stock if link.current_stock is defined else 'null' }},
                true,  // isExisting = true
                {{ link.discounted_cost if link.discounted_cost is defined else 'null' }},  // discountedCost
                {{ link.discount_percentage if link.discount_percentage is defined else 'null' }},  // discountPercentage
                {{ link.units_per_package if link.units_per_package is defined else 1 }}  // unitsPerPackage
            );
            {% endfor %}
        {% else %}
            // Add one empty row for new materials and make it primary by default
            addSupplierRow();
            const firstRadio = document.querySelector('.supplier-row input[type="radio"]');
            if (firstRadio) {
                firstRadio.checked = true;
                updatePrimarySupplier(firstRadio);
            }
        {% endif %}
    });
</script>
{% endblock %}