{% extends "base.html" %}
{% block title %}{{ _('Import Recipes') }} - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">{{ _('Import Recipes from Excel') }}</h1>
        <p class="text-secondary">{{ _('Upload an Excel file with recipes for premakes or products') }}</p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if not file_uploaded %}
<!-- Step 1: Upload Form -->
<div class="card shadow-sm">
    <div class="card-body p-5">
        <div class="text-center mb-4">
            <i class="bi bi-file-earmark-spreadsheet display-1 text-success mb-3"></i>
            <h4 class="mb-3">{{ _('Upload Recipe File') }}</h4>
        </div>

        <!-- Instructions -->
        <div class="alert alert-info mb-4">
            <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>{{ _('Required file format:') }}</h6>
            <ol class="mb-2">
                <li>{{ _('First rows must contain metadata:') }}</li>
                <pre class="bg-light p-2 mb-2" style="direction: ltr; text-align: left;">
# Recipe Import Metadata
type: premake
category: בצקים
unit: g
</pre>
                <li><strong>type:</strong> {{ _('Required - "premake" or "product"') }}</li>
                <li><strong>category:</strong> {{ _('Required - existing category name in system') }}</li>
                <li><strong>unit:</strong> {{ _('Optional - default "g"') }}</li>
                <li>{{ _('After metadata, blank row, then recipes') }}</li>
                <li>{{ _('Each recipe starts with title, 2 header rows, then materials') }}</li>
                <li>{{ _('Material types: "חומר גלם", "הכנה", "מוצר מקדים", "אבדן"') }}</li>
                <li>{{ _('Columns: name, type, price/kg, weight (g), total price') }}</li>
            </ol>
        </div>

        <form method="POST" enctype="multipart/form-data" class="text-center" style="max-width: 500px; margin: 0 auto;">
            <div class="mb-3 text-start">
                <label for="recipe_file" class="form-label">{{ _('Select Excel file:') }}</label>
                <input type="file"
                       name="recipe_file"
                       id="recipe_file"
                       class="form-control"
                       accept=".xlsx, .xls"
                       required>
            </div>
            <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-upload me-2"></i> {{ _('Load File') }}
            </button>
        </form>
    </div>
</div>

{% else %}
<!-- Step 2: Sheet Selection -->
<div class="card shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>{{ _('File uploaded successfully') }}</h5>
    </div>
    <div class="card-body p-4">
        <form method="POST" action="{{ url_for('recipe_import.select_sheet') }}">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="sheet_name" class="form-label">{{ _('Select sheet to import:') }}</label>
                    <select name="sheet_name" id="sheet_name" class="form-select" required>
                        {% for sheet in sheet_names %}
                        <option value="{{ sheet }}">{{ sheet }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {% if metadata_preview %}
            <div class="alert alert-secondary mt-3" id="metadata-preview">
                <h6 class="alert-heading">{{ _('Metadata preview:') }}</h6>
                <ul class="mb-0">
                    <li><strong>{{ _('Type:') }}</strong> <span id="metadata-type">{{ metadata_preview.type or _('Not detected (required!)') }}</span></li>
                    <li><strong>{{ _('Category:') }}</strong> <span id="metadata-category">{{ metadata_preview.category or _('Not detected (required!)') }}</span></li>
                    <li><strong>{{ _('Unit:') }}</strong> <span id="metadata-unit">{{ metadata_preview.unit }}</span></li>
                </ul>
                {% if not metadata_preview.type or not metadata_preview.category %}
                <div class="alert alert-warning mt-2 mb-0" id="metadata-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>{{ _('Note:') }}</strong> {{ _('Required metadata fields are missing. Ensure the file contains type and category rows.') }}
                </div>
                {% else %}
                <div class="alert alert-warning mt-2 mb-0 d-none" id="metadata-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>{{ _('Note:') }}</strong> {{ _('Required metadata fields are missing. Ensure the file contains type and category rows.') }}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Category creation alert (hidden by default) -->
            <div class="alert alert-warning d-none" id="categoryMissingAlert">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>{{ _('Category not found') }}</h5>
                <p>{{ _('The category') }} "<strong id="missingCategoryName"></strong>" {{ _('does not exist in the system.') }}</p>
                <button type="button" class="btn btn-sm btn-primary" id="createCategoryBtn">
                    <i class="bi bi-plus-circle me-1"></i>{{ _('Create Category') }}
                </button>
                <span class="ms-2 text-success d-none" id="categoryCreatedMsg">
                    <i class="bi bi-check-circle me-1"></i>{{ _('Category created successfully!') }}
                </span>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <a href="{{ url_for('recipe_import.upload_recipes') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-counterclockwise me-2"></i> {{ _('Upload Different File') }}
                </a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-arrow-left me-2"></i> {{ _('Continue to Review') }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if file_uploaded %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sheetSelect = document.getElementById('sheet_name');
    const metadataType = document.getElementById('metadata-type');
    const metadataCategory = document.getElementById('metadata-category');
    const metadataUnit = document.getElementById('metadata-unit');
    const metadataWarning = document.getElementById('metadata-warning');
    const categoryMissingAlert = document.getElementById('categoryMissingAlert');
    const createCategoryBtn = document.getElementById('createCategoryBtn');
    const categoryCreatedMsg = document.getElementById('categoryCreatedMsg');
    const missingCategoryName = document.getElementById('missingCategoryName');
    const continueBtn = document.querySelector('button[type="submit"]');

    let categoryCreated = false;
    let missingCategoryType = null;

    if (sheetSelect) {
        sheetSelect.addEventListener('change', function() {
            const selectedSheet = this.value;

            // Show loading state
            metadataType.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ _("Loading...") }}';
            metadataCategory.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ _("Loading...") }}';
            metadataUnit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ _("Loading...") }}';

            // Fetch metadata for selected sheet
            fetch('{{ url_for("recipe_import.get_sheet_metadata") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'sheet_name=' + encodeURIComponent(selectedSheet)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update metadata display
                metadataType.textContent = data.type || '{{ _("Not detected (required!)") }}';
                metadataCategory.textContent = data.category || '{{ _("Not detected (required!)") }}';
                metadataUnit.textContent = data.unit || 'g';

                // Show/hide warning based on missing fields
                if (!data.type || !data.category) {
                    metadataWarning.classList.remove('d-none');
                } else {
                    metadataWarning.classList.add('d-none');
                }

                // Check category existence
                if (data.category && !data.category_exists) {
                    missingCategoryName.textContent = data.category;
                    missingCategoryType = data.category_type;
                    categoryMissingAlert.classList.remove('d-none');
                    continueBtn.disabled = true;
                    categoryCreated = false;

                    // Reset the creation UI
                    createCategoryBtn.classList.remove('d-none');
                    categoryCreatedMsg.classList.add('d-none');
                } else {
                    categoryMissingAlert.classList.add('d-none');
                    if (data.type && data.category) {
                        continueBtn.disabled = false;
                    }
                    categoryCreated = true;
                }
            })
            .catch(error => {
                console.error('Error fetching metadata:', error);
                metadataType.textContent = '{{ _("Error loading") }}';
                metadataCategory.textContent = '{{ _("Error loading") }}';
                metadataUnit.textContent = '{{ _("Error loading") }}';
                metadataWarning.classList.remove('d-none');
            });
        });
    }

    // Create category button handler
    if (createCategoryBtn) {
        createCategoryBtn.addEventListener('click', function() {
            const categoryName = missingCategoryName.textContent;
            const btn = this;
            btn.disabled = true;

            fetch('{{ url_for("recipe_import.create_category_ajax") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'name=' + encodeURIComponent(categoryName) + '&type=' + encodeURIComponent(missingCategoryType)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    categoryCreated = true;
                    categoryCreatedMsg.classList.remove('d-none');
                    createCategoryBtn.classList.add('d-none');
                    continueBtn.disabled = false;
                } else {
                    alert(data.error || '{{ _("Failed to create category") }}');
                }
            })
            .catch(error => {
                console.error('Error creating category:', error);
                alert('{{ _("Failed to create category") }}');
            })
            .finally(() => {
                btn.disabled = false;
            });
        });
    }
});
</script>
{% endif %}

{% endblock %}
