{% extends "base.html" %}
{% block title %}ייבוא מתכונים - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">ייבוא מתכונים מאקסל</h1>
        <p class="text-secondary">העלאת קובץ אקסל עם מתכונים להכנות או מוצרים</p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if not file_uploaded %}
<!-- Step 1: Upload Form -->
<div class="card shadow-sm">
    <div class="card-body p-5">
        <div class="text-center mb-4">
            <i class="bi bi-file-earmark-spreadsheet display-1 text-success mb-3"></i>
            <h4 class="mb-3">העלה קובץ מתכונים</h4>
        </div>

        <!-- Instructions -->
        <div class="alert alert-info mb-4">
            <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>פורמט הקובץ הנדרש:</h6>
            <ol class="mb-2">
                <li>השורות הראשונות חייבות להכיל מטאדאטה:</li>
                <pre class="bg-light p-2 mb-2" style="direction: ltr; text-align: left;">
# Recipe Import Metadata
type: premake
category: בצקים
unit: g
</pre>
                <li><strong>type:</strong> חובה - "premake" או "product"</li>
                <li><strong>category:</strong> חובה - שם קטגוריה קיימת במערכת</li>
                <li><strong>unit:</strong> אופציונלי - ברירת מחדל "g"</li>
                <li>אחרי המטאדאטה שורה ריקה, ואז המתכונים</li>
                <li>כל מתכון מתחיל בכותרת, 2 שורות כותרות, ואז חומרי הגלם</li>
                <li>סוגי חומרים: "חומר גלם", "הכנה", "מוצר מקדים", "אבדן"</li>
                <li>עמודות: שם, סוג, מחיר לק"ג, משקל (ג'), מחיר במתכון</li>
            </ol>
        </div>

        <form method="POST" enctype="multipart/form-data" class="text-center" style="max-width: 500px; margin: 0 auto;">
            <div class="mb-3 text-start">
                <label for="recipe_file" class="form-label">בחר קובץ אקסל:</label>
                <input type="file"
                       name="recipe_file"
                       id="recipe_file"
                       class="form-control"
                       accept=".xlsx, .xls"
                       required>
            </div>
            <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-upload me-2"></i> טען קובץ
            </button>
        </form>
    </div>
</div>

{% else %}
<!-- Step 2: Sheet Selection -->
<div class="card shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>הקובץ הועלה בהצלחה</h5>
    </div>
    <div class="card-body p-4">
        <form method="POST" action="{{ url_for('recipe_import.select_sheet') }}">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="sheet_name" class="form-label">בחר גיליון לייבוא:</label>
                    <select name="sheet_name" id="sheet_name" class="form-select" required>
                        {% for sheet in sheet_names %}
                        <option value="{{ sheet }}">{{ sheet }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {% if metadata_preview %}
            <div class="alert alert-secondary mt-3" id="metadata-preview">
                <h6 class="alert-heading">תצוגה מקדימה של מטאדאטה:</h6>
                <ul class="mb-0">
                    <li><strong>סוג:</strong> <span id="metadata-type">{{ metadata_preview.type or 'לא זוהה (נדרש!)' }}</span></li>
                    <li><strong>קטגוריה:</strong> <span id="metadata-category">{{ metadata_preview.category or 'לא זוהתה (נדרש!)' }}</span></li>
                    <li><strong>יחידת מידה:</strong> <span id="metadata-unit">{{ metadata_preview.unit }}</span></li>
                </ul>
                {% if not metadata_preview.type or not metadata_preview.category %}
                <div class="alert alert-warning mt-2 mb-0" id="metadata-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>שים לב:</strong> חסרים שדות חובה במטאדאטה. ודא שהקובץ מכיל שורות type ו-category.
                </div>
                {% else %}
                <div class="alert alert-warning mt-2 mb-0 d-none" id="metadata-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>שים לב:</strong> חסרים שדות חובה במטאדאטה. ודא שהקובץ מכיל שורות type ו-category.
                </div>
                {% endif %}
            </div>
            {% endif %}

            <div class="mt-4 d-flex justify-content-end gap-2">
                <a href="{{ url_for('recipe_import.upload_recipes') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-counterclockwise me-2"></i> העלה קובץ אחר
                </a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-arrow-left me-2"></i> המשך לסקירה
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if file_uploaded %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sheetSelect = document.getElementById('sheet_name');
    const metadataType = document.getElementById('metadata-type');
    const metadataCategory = document.getElementById('metadata-category');
    const metadataUnit = document.getElementById('metadata-unit');
    const metadataWarning = document.getElementById('metadata-warning');

    if (sheetSelect) {
        sheetSelect.addEventListener('change', function() {
            const selectedSheet = this.value;

            // Show loading state
            metadataType.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>טוען...';
            metadataCategory.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>טוען...';
            metadataUnit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>טוען...';

            // Fetch metadata for selected sheet
            fetch('{{ url_for("recipe_import.get_sheet_metadata") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'sheet_name=' + encodeURIComponent(selectedSheet)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update metadata display
                metadataType.textContent = data.type || 'לא זוהה (נדרש!)';
                metadataCategory.textContent = data.category || 'לא זוהתה (נדרש!)';
                metadataUnit.textContent = data.unit || 'g';

                // Show/hide warning based on missing fields
                if (!data.type || !data.category) {
                    metadataWarning.classList.remove('d-none');
                } else {
                    metadataWarning.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error fetching metadata:', error);
                metadataType.textContent = 'שגיאה בטעינה';
                metadataCategory.textContent = 'שגיאה בטעינה';
                metadataUnit.textContent = 'שגיאה בטעינה';
                metadataWarning.classList.remove('d-none');
            });
        });
    }
});
</script>
{% endif %}

{% endblock %}
