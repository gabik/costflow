{% extends "base.html" %}
{% block title %}יומן ייצור הכנות מקדימות{% endblock %}
{% block content %}
<h1>יומן ייצור הכנות מקדימות</h1>

<!-- Form to Log New Premake Production -->
<form method="POST" class="p-4 bg-white border rounded shadow-sm">
    <div class="form-group mb-3">
        <label for="timestamp">{{ _('Timestamp') }}</label>
        <input type="datetime-local" id="timestamp" name="timestamp" class="form-control" value="{{ current_time }}" required>
    </div>
    <div class="form-group mb-3">
        <label for="premake_id" class="form-label">בחר הכנה מקדימה</label>
        <select id="premake_id" name="premake_id" class="form-select select2" required onchange="updateCalculation()">
            <option value="" disabled selected>בחר הכנה...</option>
            {% for premake in premakes %}
            <option value="{{ premake.id }}" data-batch-size="{{ premake.batch_size }}" data-unit="{{ premake.unit }}">
                {{ premake.name }} ({{ premake.unit }})
            </option>
            {% endfor %}
        </select>
        <div id="batch_info" class="form-text text-primary mt-1" style="display: none;">
            גודל באצ' (מתכון): <span id="batch_size_display" class="fw-bold"></span>
        </div>
    </div>
    <div class="form-group mb-3">
        <label for="quantity_produced">כמות שיוצרה</label>
        <div class="input-group">
            <input type="number" id="quantity_produced" name="quantity_produced" class="form-control" step="0.1" required oninput="updateCalculation()">
            <span class="input-group-text" id="unit_display">יחידה</span>
        </div>
        <div class="form-text">הכנס את הכמות הכוללת שיוצרה. המערכת תמיר זאת לבאצ'ים באופן אוטומטי.</div>
        <div id="total_weight_info" class="alert alert-info mt-2" style="display: none;">
            סה"כ כמות שנוצרה: <span id="total_weight_display" class="fw-bold"></span>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">{{ _('Log Production') }}</button>
</form>

<hr>

<!-- Display Recent Production Logs -->
<h2>היסטוריית ייצור הכנות</h2>
<table class="table table-bordered table-hover">
    <thead class="table-dark">
    <tr>
        <th>{{ _('Date') }}</th>
        <th>הכנה</th>
        <th>כמות שיוצרה</th>
        <th>{{ _('Actions') }}</th>
    </tr>
    </thead>
    <tbody>
    {% for log in production_logs %}
    <tr>
        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ log.product.name }}</td>
        <td>{{ "%.2f"|format(log.quantity_produced * log.product.batch_size) }} {{ log.product.unit }}</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editPremakeProductionModal"
                    data-log-id="{{ log.id }}" data-premake-name="{{ log.product.name }}"
                    data-quantity-units="{{ '%.2f'|format(log.quantity_produced * log.product.batch_size) }}" data-unit="{{ log.product.unit }}">
                {{ _('Edit') }}
            </button>
            <form action="{{ url_for('production.delete_premake_production_log', log_id=log.id) }}" method="POST" class="d-inline" onsubmit="return confirm('{{ _('Are you sure you want to delete this premake production log?') }}');">
                <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Edit Premake Production Modal -->
<div class="modal fade" id="editPremakeProductionModal" tabindex="-1" aria-labelledby="editPremakeProductionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editPremakeProductionForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPremakeProductionModalLabel">{{ _('Edit Premake Production Quantity') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_premake_name" class="form-label">{{ _('Premake') }}</label>
                        <input type="text" class="form-control" id="edit_premake_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit_premake_quantity_produced" class="form-label">{{ _('Quantity Produced') }}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="edit_premake_quantity_produced" name="quantity_produced" step="0.1" required>
                            <span class="input-group-text" id="edit_premake_unit_display"></span>
                        </div>
                        <div class="form-text">{{ _('Enter the total weight produced (in units). The system will convert this to batches automatically.') }}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save Changes') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updateCalculation() {
    const premakeSelect = document.getElementById('premake_id');
    const quantityInput = document.getElementById('quantity_produced');
    const unitDisplay = document.getElementById('unit_display');

    const batchInfo = document.getElementById('batch_info');
    const batchSizeDisplay = document.getElementById('batch_size_display');
    const totalInfo = document.getElementById('total_weight_info');
    const totalDisplay = document.getElementById('total_weight_display');

    const selectedOption = premakeSelect.options[premakeSelect.selectedIndex];

    if (selectedOption && selectedOption.value) {
        const batchSize = parseFloat(selectedOption.getAttribute('data-batch-size')) || 0;
        const unit = selectedOption.getAttribute('data-unit') || 'יחידה';

        // Update unit display
        unitDisplay.innerText = unit;

        batchInfo.style.display = 'block';
        batchSizeDisplay.innerText = `${batchSize.toFixed(2)} ${unit}`;

        const quantity = parseFloat(quantityInput.value) || 0;
        if (quantity > 0) {
            const total = quantity * batchSize;
            totalInfo.style.display = 'block';
            totalDisplay.innerText = `${total.toFixed(2)} ${unit}`;
        } else {
            totalInfo.style.display = 'none';
        }
    } else {
        unitDisplay.innerText = 'יחידה';
        batchInfo.style.display = 'none';
        totalInfo.style.display = 'none';
    }
}

// Bind Select2 change event since standard onchange might not fire immediately with jQuery events
document.addEventListener('DOMContentLoaded', function() {
    // Ensure jQuery is available for Select2 events if needed
    if (typeof $ !== 'undefined') {
        $('#premake_id').on('select2:select', function (e) {
            updateCalculation();
        });
    }

    // Handle Edit Premake Production Modal show event
    var editPremakeProductionModal = document.getElementById('editPremakeProductionModal');
    if (editPremakeProductionModal) {
        editPremakeProductionModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            
            // Use dataset for cleaner access
            var logId = button.dataset.logId;
            var premakeName = button.dataset.premakeName;
            var quantityUnits = button.dataset.quantityUnits;
            var unit = button.dataset.unit;

            var modalTitle = editPremakeProductionModal.querySelector('.modal-title');
            var editPremakeNameInput = editPremakeProductionModal.querySelector('#edit_premake_name');
            var editPremakeQuantityInput = editPremakeProductionModal.querySelector('#edit_premake_quantity_produced');
            var editPremakeUnitDisplay = editPremakeProductionModal.querySelector('#edit_premake_unit_display');
            var editForm = editPremakeProductionModal.querySelector('#editPremakeProductionForm');

            if (modalTitle) modalTitle.textContent = `{{ _('Edit Premake Production Quantity for') }} ${premakeName}`;
            if (editPremakeNameInput) editPremakeNameInput.value = premakeName;
            if (editPremakeQuantityInput) editPremakeQuantityInput.value = quantityUnits;
            if (editPremakeUnitDisplay) editPremakeUnitDisplay.textContent = unit;
            
            if (editForm) {
                var actionUrl = "{{ url_for('production.edit_premake_production_log', log_id=0) }}";
                editForm.action = actionUrl.replace('0', logId);
            }
        });
    }
});
</script>
{% endblock %}