{% extends "base.html" %}
{% block title %}{{ _('Premake Production Log') }}{% endblock %}
{% block content %}
<h1>{{ _('Premake Production Log') }}</h1>

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Form to Log New Premake Production -->
<form method="POST" class="p-4 bg-white border rounded shadow-sm">
    <div class="form-group mb-3">
        <label for="timestamp">{{ _('Timestamp') }}</label>
        <input type="datetime-local" id="timestamp" name="timestamp" class="form-control" value="{{ current_time }}" required>
    </div>
    <div class="form-group mb-3">
        <label for="premake_id" class="form-label">{{ _('Select Premake') }}</label>
        <select id="premake_id" name="premake_id" class="form-select select2" required>
            <option value="" disabled selected>{{ _('Select premake...') }}</option>
            {% for premake in premakes %}
            <option value="{{ premake.id }}" data-batch-size="{{ premake.batch_size }}" data-unit="{{ premake.unit }}">
                {{ premake.name }}
            </option>
            {% endfor %}
        </select>
        <div id="batch_info" class="form-text text-primary mt-1" style="display: none;">
            {{ _('Batch size (recipe):') }} <span id="batch_size_display" class="fw-bold"></span>
        </div>
    </div>
    <div class="form-group mb-3">
        <label for="quantity_produced">{{ _('Number of batches to produce') }}</label>
        <div class="input-group">
            <input type="number" id="quantity_produced" name="quantity_produced" class="form-control" step="0.1" required oninput="updateProductionDetails()">
            <span class="input-group-text">{{ _('batches') }}</span>
        </div>
        <div class="form-text">{{ _('Enter the number of batches to produce. Each batch is') }} <span id="batch_size_info" class="fw-bold"></span>.</div>
    </div>

    <div id="production_summary" style="display: none;" class="mt-4">
        <div class="alert alert-info">
            <h5 class="mb-0">{{ _('Total quantity to produce:') }} <span id="total_units_display" class="fw-bold">0</span></h5>
        </div>

        <h5 class="mt-4">{{ _('Material and Premake Usage Breakdown') }}</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered bg-light">
                <thead>
                    <tr>
                        <th>{{ _('Component') }}</th>
                        <th>{{ _('Type') }}</th>
                        <th>{{ _('Current Stock') }}</th>
                        <th>{{ _('Usage in this production') }}</th>
                        <th>{{ _('Stock after production') }}</th>
                        <th>{{ _('Unit Cost') }}</th>
                        <th>{{ _('Cost') }}</th>
                    </tr>
                </thead>
                <tbody id="components_usage_body">
                    <!-- Dynamic Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">{{ _('Log Production') }}</button>
</form>

<hr>

<!-- Display Recent Production Logs -->
<h2>{{ _('Premake Production History') }}</h2>
<table class="table table-bordered table-hover">
    <thead class="table-dark">
    <tr>
        <th>{{ _('Date') }}</th>
        <th>{{ _('Premake') }}</th>
        <th>{{ _('Quantity Produced') }}</th>
        <th>{{ _('Actions') }}</th>
    </tr>
    </thead>
    <tbody>
    {% for log in production_logs %}
    <tr>
        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ log.product.name }}</td>
        <td>{{ "%.2f"|format(log.quantity_produced) }} {{ _('batches') }} ({{ "%.2f"|format(log.quantity_produced * log.product.batch_size) }} {{ log.product.unit }})</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editPremakeProductionModal"
                    data-log-id="{{ log.id }}" data-premake-name="{{ log.product.name }}"
                    data-quantity-batches="{{ '%.2f'|format(log.quantity_produced) }}" data-batch-size="{{ log.product.batch_size }}" data-unit="{{ log.product.unit }}">
                {{ _('Edit') }}
            </button>
            <form action="{{ url_for('production.delete_premake_production_log', log_id=log.id) }}" method="POST" class="d-inline" onsubmit="return confirm('{{ _('Are you sure you want to delete this premake production log?') }}');">
                <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Edit Premake Production Modal -->
<div class="modal fade" id="editPremakeProductionModal" tabindex="-1" aria-labelledby="editPremakeProductionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editPremakeProductionForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPremakeProductionModalLabel">{{ _('Edit Premake Production Quantity') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_premake_name" class="form-label">{{ _('Premake') }}</label>
                        <input type="text" class="form-control" id="edit_premake_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit_premake_quantity_produced" class="form-label">{{ _('Number of batches') }}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="edit_premake_quantity_produced" name="quantity_produced" step="0.1" required>
                            <span class="input-group-text">{{ _('batches') }}</span>
                        </div>
                        <div class="form-text">{{ _('Enter the number of batches produced. Each batch is') }} <span id="edit_batch_size_display" class="fw-bold"></span>.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save Changes') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentRecipe = null;

$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%',
        language: { noResults: () => "{{ _('No results found') }}" }
    });

    // Handle premake selection change using Select2 specific event
    $('#premake_id').on('select2:select', function (e) {
        const premakeId = e.params.data.id;
        if (premakeId) {
            fetchRecipeData(premakeId);
        }
    });

    // Fallback for direct changes or browser autofill
    $('#premake_id').on('change', function () {
        const premakeId = $(this).val();
        if (premakeId && !currentRecipe) {
            fetchRecipeData(premakeId);
        }
    });

    // If a premake is pre-selected (e.g., on page load)
    const initialPremakeId = $('#premake_id').val();
    if (initialPremakeId) {
        fetchRecipeData(initialPremakeId);
    }

    // Handle Edit Premake Production Modal show event
    var editPremakeProductionModal = document.getElementById('editPremakeProductionModal');
    if (editPremakeProductionModal) {
        editPremakeProductionModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;

            var logId = button.dataset.logId;
            var premakeName = button.dataset.premakeName;
            var quantityBatches = button.dataset.quantityBatches;
            var batchSize = button.dataset.batchSize;
            var unit = button.dataset.unit;

            var modalTitle = editPremakeProductionModal.querySelector('.modal-title');
            var editPremakeNameInput = editPremakeProductionModal.querySelector('#edit_premake_name');
            var editPremakeQuantityInput = editPremakeProductionModal.querySelector('#edit_premake_quantity_produced');
            var editBatchSizeDisplay = editPremakeProductionModal.querySelector('#edit_batch_size_display');
            var editForm = editPremakeProductionModal.querySelector('#editPremakeProductionForm');

            if (modalTitle) modalTitle.textContent = `{{ _('Edit Premake Production Quantity for') }} ${premakeName}`;
            if (editPremakeNameInput) editPremakeNameInput.value = premakeName;
            if (editPremakeQuantityInput) editPremakeQuantityInput.value = quantityBatches;
            if (editBatchSizeDisplay) editBatchSizeDisplay.textContent = `${parseFloat(batchSize).toFixed(2)} ${unit}`;

            if (editForm) {
                var actionUrl = "{{ url_for('production.edit_premake_production_log', log_id=0) }}";
                editForm.action = actionUrl.replace('0', logId);
            }
        });
    }
});

function fetchRecipeData(premakeId) {
    console.log('Fetching recipe for premake:', premakeId);
    const batches = parseFloat(document.getElementById('quantity_produced').value) || 1;
    fetch(`/api/premake_recipe/${premakeId}?quantity=${batches}&t=${Date.now()}`)  // Add cache busting
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);  // DEBUG: Show API response
            currentRecipe = data;
            currentRecipe.fetched_quantity = batches;

            // Update batch size info
            const batchInfo = document.getElementById('batch_info');
            const batchSizeDisplay = document.getElementById('batch_size_display');
            const batchSizeInfo = document.getElementById('batch_size_info');

            batchInfo.style.display = 'block';
            batchSizeDisplay.innerText = `${data.batch_size.toFixed(2)} ${data.unit}`;
            batchSizeInfo.innerText = `${data.batch_size.toFixed(2)} ${data.unit}`;

            updateProductionDetails();
            document.getElementById('production_summary').style.display = 'block';
        })
        .catch(error => console.error('Error loading recipe:', error));
}

function updateProductionDetails() {
    if (!currentRecipe) return;

    const qtyInput = document.getElementById('quantity_produced');
    const batches = parseFloat(qtyInput.value) || 0;

    // Update Total Units (batches × batch_size)
    const totalUnits = batches * currentRecipe.batch_size;
    document.getElementById('total_units_display').innerText = `${batches.toFixed(2)} {{ _("batches") }} (${totalUnits.toFixed(2)} ${currentRecipe.unit})`;

    // If quantity changed significantly, fetch updated breakdown
    if (batches > 0 && (!currentRecipe.fetched_quantity || Math.abs(currentRecipe.fetched_quantity - batches) > 0.01)) {
        const premakeId = document.getElementById('premake_id').value;
        if (premakeId) {
            fetchRecipeData(premakeId);
            return;
        }
    }

    // Update Table
    const tbody = document.getElementById('components_usage_body');
    tbody.innerHTML = '';

    let totalRecipeCost = 0;

    currentRecipe.components.forEach(comp => {
        if (comp.type === 'Raw Material' && comp.consumption_breakdown && comp.consumption_breakdown.length > 0) {
            // Use new consumption breakdown for raw materials
            const consumptionRows = comp.consumption_breakdown.filter(c => c.amount_to_consume > 0 || c.is_primary);

            if (consumptionRows.length === 1 && !consumptionRows[0].is_deficit) {
                // Single supplier case - show material name without supplier
                const consumption = consumptionRows[0];
                const tr = document.createElement('tr');
                // Add discount indicator if applicable
                let costDisplay = `${consumption.cost_per_unit.toFixed(2)} ₪`;
                if (consumption.original_cost && consumption.cost_per_unit < consumption.original_cost) {
                    const discountPercent = Math.round((1 - consumption.cost_per_unit/consumption.original_cost) * 100);
                    costDisplay = `<span class="text-decoration-line-through text-muted">${consumption.original_cost.toFixed(2)} ₪</span> <strong class="text-success">${consumption.cost_per_unit.toFixed(2)} ₪</strong> <span class="badge bg-success">-${discountPercent}%</span>`;
                }
                tr.innerHTML = `
                    <td>${comp.name}</td>
                    <td>{{ _('Raw Material') }}</td>
                    <td>${consumption.stock_available.toFixed(2)} ${comp.unit}</td>
                    <td class="fw-bold">${consumption.amount_to_consume.toFixed(2)} ${comp.unit}</td>
                    <td class="${consumption.remaining_after < 0 ? 'text-danger fw-bold' : ''}">${consumption.remaining_after.toFixed(2)} ${comp.unit}</td>
                    <td>${costDisplay}</td>
                    <td>${consumption.total_cost.toFixed(2)} ₪</td>
                `;
                tbody.appendChild(tr);
                totalRecipeCost += consumption.total_cost;
            } else {
                // Multiple suppliers or deficit case - show separate rows
                consumptionRows.forEach((consumption, index) => {
                    const tr = document.createElement('tr');
                    let nameDisplay = '';

                    if (index === 0) {
                        nameDisplay = `${comp.name} <small class="text-muted">(${consumption.supplier_name})</small>`;
                    } else {
                        nameDisplay = `<span class="ms-3">└─ ${consumption.supplier_name}</span>`;
                    }

                    if (consumption.is_deficit) {
                        nameDisplay += ' <span class="badge bg-danger ms-1">{{ _('Shortage') }}</span>';
                    }

                    // Add discount indicator if applicable
                    let costDisplay = `${consumption.cost_per_unit.toFixed(2)} ₪`;
                    if (consumption.original_cost && consumption.cost_per_unit < consumption.original_cost) {
                        const discountPercent = Math.round((1 - consumption.cost_per_unit/consumption.original_cost) * 100);
                        costDisplay = `<span class="text-decoration-line-through text-muted">${consumption.original_cost.toFixed(2)} ₪</span> <strong class="text-success">${consumption.cost_per_unit.toFixed(2)} ₪</strong> <span class="badge bg-success">-${discountPercent}%</span>`;
                    }

                    tr.innerHTML = `
                        <td>${nameDisplay}</td>
                        <td>${index === 0 ? '{{ _("Raw Material") }}' : ''}</td>
                        <td>${consumption.stock_available.toFixed(2)} ${comp.unit}</td>
                        <td class="fw-bold">${consumption.amount_to_consume.toFixed(2)} ${comp.unit}</td>
                        <td class="${consumption.remaining_after < 0 ? 'text-danger fw-bold' : ''}">${consumption.remaining_after.toFixed(2)} ${comp.unit}</td>
                        <td>${costDisplay}</td>
                        <td>${consumption.total_cost.toFixed(2)} ₪</td>
                    `;
                    tbody.appendChild(tr);
                    totalRecipeCost += consumption.total_cost;
                });
            }
        } else {
            // Fallback for premakes, packaging, unlimited materials, or old data structure
            const usage = comp.qty_per_batch * batches;
            const cost = usage * comp.cost_per_unit;
            totalRecipeCost += cost;

            // Handle unlimited materials
            const isUnlimited = comp.is_unlimited || comp.current_stock === null;
            let currentStockDisplay, stockAfterDisplay;
            let stockAfter = 0;

            if (isUnlimited) {
                currentStockDisplay = '<span class="badge bg-primary fs-6">∞</span>';
                stockAfterDisplay = '<span class="badge bg-primary fs-6">∞</span>';
            } else {
                stockAfter = comp.current_stock - usage;
                currentStockDisplay = `${comp.current_stock.toFixed(2)} ${comp.unit}`;
                stockAfterDisplay = `${stockAfter.toFixed(2)} ${comp.unit}`;
            }

            // Check for deficit
            const hasDeficit = !isUnlimited && (comp.is_deficit || stockAfter < 0);
            let nameDisplay = comp.name;
            if (hasDeficit) {
                nameDisplay += ' <span class="badge bg-danger ms-1">{{ _('Shortage') }}</span>';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${nameDisplay}</td>
                <td>${comp.type === 'Raw Material' ? '{{ _("Raw Material") }}' : (comp.type === 'Packaging' ? '{{ _("Packaging") }}' : '{{ _("Premake") }}')}</td>
                <td>${currentStockDisplay}</td>
                <td class="fw-bold">${usage.toFixed(2)} ${comp.unit}</td>
                <td class="${!isUnlimited && stockAfter < 0 ? 'text-danger fw-bold' : ''}">${stockAfterDisplay}</td>
                <td>${comp.cost_per_unit.toFixed(2)} ₪</td>
                <td>${cost.toFixed(2)} ₪</td>
            `;
            tbody.appendChild(tr);
        }
    });

    // Add total cost row
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="6" class="text-end fw-bold">{{ _('Total production cost') }}</td>
        <td class="fw-bold">${totalRecipeCost.toFixed(2)} ₪</td>
    `;
    tbody.appendChild(totalRow);
}
</script>
{% endblock %}