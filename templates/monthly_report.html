{% extends "base.html" %}
{% block title %}דו"ח חודשי - CostFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary">דו"ח חודשי</h1>
        <p class="text-secondary">
            סיכום ביצועים לחודש {{ month }}/{{ year }}
            ({{ month_start.strftime('%d/%m/%Y') }} - {{ month_end.strftime('%d/%m/%Y') }})
        </p>
    </div>
</div>

<!-- Month Selector -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="GET" action="{{ url_for('reports.monthly_report') }}" class="d-flex gap-2">
            <select name="month" class="form-select" style="width: 150px;">
                {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>
                    {{ ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'][m-1] }}
                </option>
                {% endfor %}
            </select>
            <input type="number" name="year" value="{{ year }}" min="2020" max="2030" class="form-control" style="width: 100px;">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search me-2"></i>הצג דו"ח
            </button>
        </form>
    </div>
    <div class="col-md-6 text-end">
        <button onclick="window.print()" class="btn btn-outline-secondary">
            <i class="bi bi-printer me-2"></i>הדפסה
        </button>
    </div>
</div>

{% if no_data %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    לא נמצאו נתונים עבור החודש הנבחר
</div>
{% else %}

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">סך הכנסות</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(total_revenue) }}</h3>
                <small>ממוצע שבועי: {{ currency_symbol }}{{ "%.2f"|format(avg_weekly_revenue) }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6 class="card-title">עלות חומרים</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(total_material_costs) }}</h3>
                <small>ממוצע שבועי: {{ currency_symbol }}{{ "%.2f"|format(avg_weekly_material) }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-title">עלות לייבור</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(total_labor_costs) }}</h3>
                <small>ממוצע שבועי: {{ currency_symbol }}{{ "%.2f"|format(avg_weekly_labor) }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">רווח נטו</h6>
                <h3 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(net_profit) }}</h3>
                <small>{{ "%.1f"|format((net_profit / total_revenue * 100) if total_revenue > 0 else 0) }}%</small>
            </div>
        </div>
    </div>
</div>

<!-- Food Cost Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-body">
                <h5 class="card-title text-primary mb-3">
                    <i class="bi bi-calculator me-2"></i>ניתוח עלות מזון (Food Cost) - חודשי
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">סך עלות מזון</h6>
                            <h3 class="text-primary">{{ currency_symbol }}{{ "%.2f"|format(total_food_cost) }}</h3>
                            <small class="text-muted">ממוצע שבועי: {{ currency_symbol }}{{ "%.2f"|format(avg_weekly_food_cost) }}</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">עלות ממוצעת למתכון</h6>
                            <h3 class="text-info">{{ currency_symbol }}{{ "%.2f"|format(avg_food_cost_per_recipe) }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">סך מתכונים שיוצרו</h6>
                            <h3 class="text-success">{{ total_recipes_produced }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">אחוז עלות מזון</h6>
                            <h3 class="{% if total_revenue > 0 and total_food_cost > 0 %}{% if (total_food_cost / total_revenue * 100) > 35 %}text-danger{% elif (total_food_cost / total_revenue * 100) < 25 %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                                {{ "%.1f"|format((total_food_cost / total_revenue * 100) if total_revenue > 0 else 0) }}%
                            </h3>
                            <small class="text-muted">(יעד: 25-35%)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Food Cost Trends Chart -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>מגמת עלות מזון שבועית</h5>
    </div>
    <div class="card-body">
        {% if weekly_summaries %}
        <div class="food-cost-chart">
            {% set max_food_cost = weekly_summaries|map(attribute='food_cost')|max %}
            {% for week in weekly_summaries %}
            <div class="week-bar-container">
                <div class="week-info">
                    <div class="week-label">{{ week.week_start.strftime('%d/%m') }}</div>
                    <div class="week-bar-wrapper">
                        <div class="week-bar"
                             style="width: {{ (week.food_cost / max_food_cost * 100) if max_food_cost > 0 else 0 }}%"
                             data-bs-toggle="tooltip"
                             data-bs-placement="top"
                             title="{{ currency_symbol }}{{ '%.2f'|format(week.food_cost) }} ({{ '%.1f'|format((week.food_cost / week.revenue * 100) if week.revenue > 0 else 0) }}%)">
                        </div>
                    </div>
                    <div class="week-value">{{ currency_symbol }}{{ "%.0f"|format(week.food_cost) }}</div>
                    <div class="week-percent {% if week.revenue > 0 and week.food_cost > 0 %}{% if (week.food_cost / week.revenue * 100) > 35 %}text-danger{% elif (week.food_cost / week.revenue * 100) < 25 %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                        {{ "%.1f"|format((week.food_cost / week.revenue * 100) if week.revenue > 0 else 0) }}%
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="target-line" style="bottom: 30%;" title="יעד 30%">
                <span class="target-label">יעד: 30%</span>
            </div>
        </div>

        <style>
        .food-cost-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 250px;
            padding: 20px 10px;
            border-left: 2px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
            position: relative;
            margin-bottom: 20px;
        }

        .week-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            max-width: 80px;
            margin: 0 5px;
        }

        .week-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .week-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .week-bar-wrapper {
            width: 40px;
            height: 150px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .week-bar {
            width: 100%;
            background: linear-gradient(to top, #0d6efd, #6cb2ff);
            border-radius: 4px 4px 0 0;
            transition: opacity 0.3s;
            cursor: pointer;
            min-height: 10px;
        }

        .week-bar:hover {
            opacity: 0.8;
        }

        .week-value {
            font-size: 11px;
            font-weight: bold;
            color: #0d6efd;
            margin-top: 5px;
            text-align: center;
        }

        .week-percent {
            font-size: 11px;
            font-weight: bold;
            margin-top: 2px;
        }

        .target-line {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 2px dashed #28a745;
            opacity: 0.5;
        }

        .target-label {
            position: absolute;
            right: -60px;
            top: -8px;
            font-size: 11px;
            color: #28a745;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .food-cost-chart {
                overflow-x: auto;
                min-width: 500px;
            }
        }
        </style>
        {% else %}
        <p class="text-muted">אין נתונים להצגה</p>
        {% endif %}
    </div>
</div>

<!-- Weekly Trends -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>מגמות שבועיות</h5>
    </div>
    <div class="card-body">
        {% if weekly_summaries %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>שבוע</th>
                        <th>הכנסות</th>
                        <th>עלות מזון</th>
                        <th>Food Cost %</th>
                        <th>מתכונים</th>
                        <th>עלות חומרים</th>
                        <th>עלות לייבור</th>
                        <th>הפרשי מלאי</th>
                        <th>רווח נטו</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in weekly_summaries %}
                    <tr>
                        <td class="fw-medium">{{ week.week_start.strftime('%d/%m') }} - {{ week.week_end.strftime('%d/%m') }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(week.revenue) }}</td>
                        <td class="text-primary fw-bold">{{ currency_symbol }}{{ "%.2f"|format(week.food_cost) }}</td>
                        <td class="{% if week.revenue > 0 and week.food_cost > 0 %}{% if (week.food_cost / week.revenue * 100) > 35 %}text-danger{% elif (week.food_cost / week.revenue * 100) < 25 %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                            {{ "%.1f"|format((week.food_cost / week.revenue * 100) if week.revenue > 0 else 0) }}%
                        </td>
                        <td>{{ week.recipes_produced }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(week.material_cost) }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(week.labor_cost) }}</td>
                        <td class="{% if week.stock_variance_cost < 0 %}text-danger{% elif week.stock_variance_cost > 0 %}text-success{% endif %}">
                            {{ currency_symbol }}{{ "%.2f"|format(week.stock_variance_cost) }}
                        </td>
                        <td class="{% if week.profit > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ currency_symbol }}{{ "%.2f"|format(week.profit) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>סה"כ</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(total_revenue) }}</th>
                        <th class="text-primary fw-bold">{{ currency_symbol }}{{ "%.2f"|format(total_food_cost) }}</th>
                        <th>{{ "%.1f"|format((total_food_cost / total_revenue * 100) if total_revenue > 0 else 0) }}%</th>
                        <th>{{ total_recipes_produced }}</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(total_material_costs) }}</th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(total_labor_costs) }}</th>
                        <th class="{% if total_stock_variance_cost < 0 %}text-danger{% endif %}">
                            {{ currency_symbol }}{{ "%.2f"|format(total_stock_variance_cost) }}
                        </th>
                        <th>{{ currency_symbol }}{{ "%.2f"|format(net_profit) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <p class="text-muted">אין נתונים שבועיים</p>
        {% endif %}
    </div>
</div>

<!-- Category Performance -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>ביצועי קטגוריות</h5>
    </div>
    <div class="card-body">
        {% if category_summaries %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>קטגוריה</th>
                        <th>מוצרים</th>
                        <th>כמות נמכרה</th>
                        <th>כמות פחת</th>
                        <th>הכנסות</th>
                        <th>עלות חומרים</th>
                        <th>רווח גולמי</th>
                        <th>שבועות פעילים</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cat_name, cat_data in category_summaries.items() %}
                    <tr>
                        <td class="fw-medium">{{ cat_name }}</td>
                        <td>{{ cat_data.product_count }}</td>
                        <td>{{ cat_data.quantity_sold|int }}</td>
                        <td>{{ cat_data.quantity_waste|int }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(cat_data.revenue) }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(cat_data.material_cost) }}</td>
                        <td class="{% if cat_data.revenue - cat_data.material_cost > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ currency_symbol }}{{ "%.2f"|format(cat_data.revenue - cat_data.material_cost) }}
                        </td>
                        <td>{{ cat_data.weeks_active }}/{{ num_weeks }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">אין נתוני קטגוריות</p>
        {% endif %}
    </div>
</div>

<!-- Top 10 Products -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>10 המוצרים המובילים</h5>
    </div>
    <div class="card-body">
        {% if top_products %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>מוצר</th>
                        <th>קטגוריה</th>
                        <th>כמות נמכרה</th>
                        <th>הכנסות</th>
                        <th>% מההכנסות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in top_products %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td class="fw-medium">{{ product.name }}</td>
                        <td>{{ product.category_name }}</td>
                        <td>{{ product.quantity_sold|int }}</td>
                        <td>{{ currency_symbol }}{{ "%.2f"|format(product.revenue) }}</td>
                        <td>{{ "%.1f"|format((product.revenue / total_revenue * 100) if total_revenue > 0 else 0) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">אין נתוני מוצרים</p>
        {% endif %}
    </div>
</div>

<!-- Monthly Insights -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>תובנות חודשיות</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary mb-3">נתונים מרכזיים</h6>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="bi bi-calendar-week text-info me-2"></i>
                        מספר שבועות פעילים: <strong>{{ num_weeks }}</strong>
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-graph-up text-success me-2"></i>
                        הכנסה שבועית ממוצעת: <strong>{{ currency_symbol }}{{ "%.2f"|format(avg_weekly_revenue) }}</strong>
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-percent text-primary me-2"></i>
                        שיעור רווח חודשי: <strong>{{ "%.1f"|format((net_profit / total_revenue * 100) if total_revenue > 0 else 0) }}%</strong>
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-calculator text-info me-2"></i>
                        עלות מזון חודשית: <strong class="text-primary">{{ currency_symbol }}{{ "%.2f"|format(total_food_cost) }}</strong>
                        ({{ "%.1f"|format((total_food_cost / total_revenue * 100) if total_revenue > 0 else 0) }}% מההכנסות)
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-graph-down text-success me-2"></i>
                        עלות מזון ממוצעת למתכון: <strong>{{ currency_symbol }}{{ "%.2f"|format(avg_food_cost_per_recipe) }}</strong>
                    </li>
                    {% if total_stock_variance_cost != 0 %}
                    <li class="mb-2">
                        <i class="bi bi-clipboard-check text-warning me-2"></i>
                        הפרשי מלאי חודשיים: <strong class="{% if total_stock_variance_cost < 0 %}text-danger{% endif %}">
                            {{ currency_symbol }}{{ "%.2f"|format(total_stock_variance_cost) }}
                        </strong>
                    </li>
                    {% endif %}
                </ul>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary mb-3">ביצועים מובילים</h6>
                <ul class="list-unstyled">
                    {% if category_summaries %}
                        {% set best_category = category_summaries.items()|sort(attribute='1.revenue', reverse=True)|first %}
                        {% if best_category %}
                        <li class="mb-2">
                            <i class="bi bi-star-fill text-warning me-2"></i>
                            קטגוריה מובילה: <strong>{{ best_category[0] }}</strong>
                            ({{ currency_symbol }}{{ "%.2f"|format(best_category[1].revenue) }})
                        </li>
                        {% endif %}
                    {% endif %}

                    {% if top_products %}
                        <li class="mb-2">
                            <i class="bi bi-trophy-fill text-success me-2"></i>
                            מוצר מוביל: <strong>{{ top_products[0].name }}</strong>
                            ({{ currency_symbol }}{{ "%.2f"|format(top_products[0].revenue) }})
                        </li>
                    {% endif %}

                    {% if weekly_summaries %}
                        {% set best_week = weekly_summaries|sort(attribute='profit', reverse=True)|first %}
                        {% if best_week %}
                        <li class="mb-2">
                            <i class="bi bi-award-fill text-info me-2"></i>
                            השבוע הרווחי ביותר: <strong>{{ best_week.week_start.strftime('%d/%m') }}</strong>
                            ({{ currency_symbol }}{{ "%.2f"|format(best_week.profit) }})
                        </li>
                        {% endif %}
                    {% endif %}
                </ul>
            </div>
        </div>

        {% if category_summaries %}
            {% set total_waste = category_summaries.values()|sum(attribute='quantity_waste') %}
            {% set total_sold = category_summaries.values()|sum(attribute='quantity_sold') %}
            {% if total_sold > 0 %}
            <div class="alert alert-warning mt-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>שיעור פחת חודשי:</strong>
                {{ "%.1f"|format((total_waste / (total_sold + total_waste) * 100) if (total_sold + total_waste) > 0 else 0) }}%
                ({{ total_waste }} יחידות מתוך {{ total_sold + total_waste }})
            </div>
            {% endif %}
        {% endif %}
    </div>
</div>

{% endif %}

<style>
@media print {
    .navbar, .btn, form {
        display: none !important;
    }
    .card {
        break-inside: avoid;
    }
    body {
        font-size: 12px;
    }
}
</style>

{% endblock %}